<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>promptGenAI - API Chat Interface</title>
    <style>
      /* Basic reset */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif, Arial;
      }
      /* Minimalist grayscale styling */
      html, body {
        box-sizing: border-box;
        display: flex;
        flex: 1;
        background: white;
        color: #333;
        height: 100%;
        width: 100%;
        font-size: 1rem;
      }
      .container {
        box-sizing: border-box;
        display: flex;
        flex: 1;
        flex-direction: column;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 2px;
        margin: 1px;
        overflow: hidden;
        max-width: 100%;
      }
      .header {
        box-sizing: border-box;
        display: inline-flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #f8f8f8;
        border-bottom: 1px solid #ccc;
      }
      .header h2 {
        color: #212121;
        margin-right: 2rem;
        align-items: flex-end;
      }
      .header-nav {
        box-sizing: border-box;
        display: inline-flex;
        padding: 6px;
      }
      /* Hamburger menu styles */
      .hamburger {
        cursor: pointer;
        display: none;
      }
      .sm-buttons-container {
        box-sizing: border-box;
        display: inline-flex;
        flex-direction: row;
        flex-wrap: nowrap;
      }
      .sm-buttons-container * {
        font-size: .8em;
        padding: .3em .6em;
        margin-left: 0px;
        margin-right: .5em;
        background: transparent;
        border: transparent;
      }

      .toggle-buttons-container {
        box-sizing: border-box;
        display: inline-flex;
        padding: 6px;
        margin: 0px;
        margin-left: 0px;
      }
      .toggle-buttons-container * {
        font-size: .8em;
        padding: .3em .6em;
        margin-left: 0px;
        margin-right: .5em;
      }
      .page-content {
        box-sizing: border-box;
        display: flex;
        flex: 1;
        height: 100%;
        width: 100%;
        max-width: 100%;
        overflow: hidden; /* Prevent scrolling on the main content itself */
        overflow-x: none;
      }
      .sidebar {
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        flex: 0 1 230px;
        padding: 1rem;
        border-right: 1px solid #ccc;
        height: 100%;
        max-width: 100%;
        border-radius: 6px;
        padding: 6px;
      }
      .sidebar-right {
        min-width: 250px;
      }
      .sidebar-header {
        box-sizing: border-box;
        display: inline-flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .header h2,
      .sidebar-header h2,
      .sidebar-header h3 {
        box-sizing: border-box;
        margin-right: 6px;
      }
      .sidebar-content {
        box-sizing: border-box;
        display: flex;
        flex: 1;
        max-height: 100%;
        height: 100%;
        width: 100%;
        overflow-y: auto;
        border: none;
      }
      .parameters-container,
      .codeView-input,
      .functionDef-input,
      .system-input {
        flex-grow: 1;
        height: 100%;
        width: 100%;
        border: none;
      }
      .codeView-input,
      .functionDef-input,
      .system-input {
        resize: horizontal;
        overflow-y: auto;
        max-width: 100%;
        min-width: 100%;
        min-height: 100%;
        max-height: 100%;
      }
      .codeView-input,
      .functionDef-input,
      .system-input {
        font-family: monospace;
        white-space: pre;
      }
      .conversation-zone {
        box-sizing: border-box;
        flex: 1;
        padding: 1rem;
        border-left: 1px solid #ccc;
        border-right: 1px solid #ccc;
        max-width: 100%;
      }
      .footer {
        padding: 3px;
        background: #f8f8f8;
        border-top: 1px solid #ccc;
      }
      #statusBarText {
        font-size: .75rem;
        font-style: italic;
        word-break: keep-all;
      }

      /* Toggle button styling */
      .toggle-button {
        padding: 0.5rem 1rem;
        margin-right: 0.5rem;
        background: none;
        color: #121212;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
      }
      /* Close button inside sidebars */
      .close-button,
      .help-button,
      .clear-button,
      .update-button {
        padding: 0.3rem 0.6rem;
        border: none;
        background-color: transparent;
        color: #333;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
        float: right;
      }
      button:hover {
        background-color: #bbb;
      }
    </style>

    <style>
      .api-settings-container,
      .tts-settings-container,
      .ext-controls-container {
        box-sizing: border-box;
        display: flex;
        flex: 1;
        flex-direction: column;
      }
    </style>

    
<style>
  .code-frame {
    border: 1px solid #ccc;
    padding: 10px;
    position: relative;
    margin-bottom: 10px;
  }
  
  .code-frame .button-container {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    flex-direction: row;
    justify-content: flex-end;
  }
  
  .code-frame .button-container .copy-button,
  .code-frame .button-container .toggle-button {
        background-color: transparent;
        font-size: 14px;
        font-family: monospace;
        border-radius: 5px;
        border: 1px solid grey;
        color: grey;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 3px;
  }

  .code-frame .button-container .copy-button + .toggle-button {
    margin-left: 0.5em; /* Adjust as needed */
  }  
</style>  
    
<style>
  .xcode {
    display: flex;
    flex-direction: column;
    background-color: #f0f0f0; 
    padding: 10px; 
    border-radius: 5px; 
    border: 2px solid grey;
  }
  
  .content-block .code-frame { 
    font-size: smaller;
    font-family: monospace;

  }
  
</style>    
    
    
    <style>
      .conversation-zone {
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: 0;
      }
      #chat-container {
        flex: 1;
        display: flex;
        flex-grow: 1;
        flex-direction: column-reverse;
        padding: 20px;
        overflow-y: auto;
        box-sizing: border-box;
      }
      #chat-interface {
        display: flex;
        margin-top: auto;
        padding-left: 20px;
        padding-right: 20px;
        padding-bottom: 6px;
      }
      /* Style the chat user input */
      #message-input {
        box-sizing: border-box;
        flex-grow: 1;
        resize: vertical;
        padding: 0.5rem;
        border: none;
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        margin-right: 0.5rem;
        padding-bottom: 0rem;
        height: 3em;
        min-width: 5em;
      }

      /* testing Style the chat user input */
      #chat-user-input {
        min-height: 2em;
        overflow-y: auto;
      }
      .tts {
      }
      /* Style the send button and loading indicator container */
      .tts-button,
      .send-button,
      .chat-loading-container {
        box-sizing: border-box;
        width: 4em;
        min-width: 4em;
        height: 100%;
        border: 1px solid #ccc;
        background-color: #f5f5f5;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .tts-button {
        margin-right: 0.5rem;
      }

      .send-button-container {
        position: relative;
        display: inline-block;
      }
      .send-button-indicator {
        position: absolute;
        top: .5em;
        right: .5em;
        transform: translate(50%, -50%);
        width: .5em;
        height: .5em;
        border-radius: 50%;
        background-color: lightgrey;
      }
      .send-button-indicator.ready {
        background-color: var(--icon-bg, #4caf50);
      }

      .chat-loading {
        border: .3rem solid #eaeaea;
        border-radius: 50%;
        border-top: .3rem solid #121212;
        width: 1.5rem;
        height: 1.5rem;
        animation: spin 2s linear infinite;
        padding: .7rem;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .message {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        padding-bottom: 6px;
      }
      .chat-message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #565869;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: .08rem;
        line-height: 16px;
        padding-top: 6px;
        padding-bottom: 6px;
      }

      .role-indicator {
        text-transform: uppercase;
        color: red;
      }

      .role-indicator,
      .alt-indicator {
        margin-right: 5px;
      }
      .message-type-selector {
        display: flex;
        margin-left: auto;
        background-color: transparent;
        border: none;
        cursor: pointer;
        justify-content: flex-end;
        text-align: right; /* This aligns text inside the selector to the right */
      }
      .remove-message-button {
        background-color: transparent;
        font-size: 14px;
        font-family: monospace;
        height: 1em;
        width: 1em;
        border-radius: 50%;
        border: 1px solid grey;
        color: grey;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-left: 3rem;
      }
      .content {
        display: none;
      }

      .visible {
        display: flex;
      }
      .hidden {
        display: none;
      }
    </style>

    <style>
      .input-pair label {
        display: block;
        margin-bottom: 3px;
        font-size: .8em;
      }
      .input-pair input,
      .input-pair select,
      .input-pair button {
        width: 100%;
        padding: 3px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .separator {
        border-top: 1px solid #ccc;
        margin: .8em 0;
      }

      .parameters-container .input-pair {
        margin-bottom: 9px;
        margin-left: .5rem;
        margin-right: .5rem;
      }
      .tts-settings-container .input-pair{
        margin-bottom: .5px;
        margin-left: .5rem;
        margin-right: .5rem;
      }

      .tts-settings-container .input-pair label,
      .tts-settings-container .input-pair input[type="range"] {
        flex: 1;
        margin-bottom: 0px;
      }
      .tts-settings-container .input-pair input[type="text"] {
        display: flex;
        flex: 1;
        margin-bottom: 0px;
        max-width: 2em;
        padding: .25em;
        margin-right: .5em;
        text-align: center;
      }

      .kit-container {
        border: 1px solid #ccc;
      }
      .indicatorArea {
        width: 100%;
      }
    </style>

    <style>
      .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 640px;
        height: 66vh;
        background: white;
        box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        z-index: 2;
        display: none;
      }

      .popup-header {
        padding: 10px;
        background: #f7f7f7;
        border-bottom: 1px solid #ddd;
        font-size: 18px;
        text-align: center;
      }

      .popup-table {
        max-height: calc(66vh - 60px);
        overflow-y: auto;
      }
      .overlay {
        position: fixed;
        display: none;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 1;
      }
      .open-popup {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        margin: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      table, th, td {
        border: 1px solid #ddd;
      }
      th, td {
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
        position: sticky;
        top: 0;
      }

      .slider-container {
        display: flex;
        align-items: center;
      }
      input[type="range"] {
        flex: 1;
        margin-right: 10px;
      }
      input[type="text"] {
        flex: 1;
      }
    </style>

    <style>
      .api-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .api-card {
        border: 1px solid #ccc;
        border-radius: 1px;
        margin: 1px;
        margin-top: 6px;
        padding: 3px;
        font-size: .8rem;
        text-align: center;
        box-shadow: inset 0 0 5px rgba(255,255,255,.5);
        transform: scale(0.98);
        color: #121212;
      }
      .api-card.ready {
        background-color: lightgreen;
      }
      .api-card.na {
        background-color: lightcoral;
      }
      .api-card.none {
        background-color: lightgray;
      }

      .api-card.selected {
        box-shadow: inset 0 0 5px rgba(0,0,0,.5);
        transform: scale(0.98);
        color: #212121;
      }
    </style>

<style>
pre {
  background-color: #f8f8f8;
  padding: 10px;
  border-radius: 5px;
  overflow: auto;
  white-space: pre-wrap; /* Wrap the code */
}

.code,
.json,  
.htmltxt {
  font-size: smaller;
  font-family: monospace;  
  color: #333;
/*font-family: 'Courier New', Courier, monospace;*/
/*background-color: #f4f4f4;*/
/*white-space: pre-wrap;  Allows line breaks */
/*word-wrap: break-word;  Prevents long words from overflowing */
}
  
.htmlrnd {
  flex-direction: column;
  background-color: #f0f0f0; 
  padding: 10px; 
  border-radius: 5px; 
  border: 2px solid red;
}
  
.text,
.textn {
}
</style>

    
    <style>
      @media (max-width: 768px) {
        .header {
          font-size: .7rem;
          padding: .5rem;
        }
        .header h1 {
          margin-right: 1rem;
        }
        .header-nav {
          padding: 3px;
          flex-direction: row;
          padding-bottom: 0px;
        }
        .toggle-button {
          padding: 3px;
          margin-right: .2rem;
          flex-shrink: 1;
        }
        .page-content {
          flex-direction: column;
          overflow-y: auto;
        }
        .sidebar {
          order: -1;
          border-right: none;
          border-radius: 0px;
          border: 1px solid #d3d3d3;
          box-shadow: 5px 5px 10px #a9a9a9;
          margin-bottom: 18px;
        }
        .codeView-input,
        .functionDef-input,
        .system-input {
          resize: vertical;
          overflow: auto;
          width: 100%;
        }
        .conversation-zone {
          border-left: none;
        }
        .popup {
          width: 95%;
        }
      }

      @media (max-width: 450px) {
        .header {
          flex-direction: column;
          align-items: flex-start;
        }
        .header h2 {
          display: flex;
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          width: 100%;
        }
        .header-nav {
          flex-direction: column;
          align-items: flex-start;
          width: 100%;
        }
        .header-nav.hidden {
          display: none;
        }
        .header-nav button {
          width: 100%;
          text-align: left;
        }
        .hamburger {
          display: flex;
        }
      }

      @media (min-width: 769px) {
        .codeView-input,
        .functionDef-input,
        .system-input {
          height: 100%;
        }
      }
    </style>
    
  </head>
  <body>
  <div class="container">
    <header class="header">
      <h2>
        <div>
          <span style="color: #212121;">prompt</span>
          <span style="color: red;">GenAI</span>
          <span id="github" style="color:#ccc;font-size:.5em">
            <a style="color: #212121;" href="https://github.com/aznight85048/promptgenai" target="_blank">github</a>@202405
          </span>
        </div>
        <div class="h2-container">
          <div class="hamburger" onclick="toggleVisibility('headerNav');">&#9776;</div>
        </div>
      </h2>
      <div class="header-nav" id="headerNav">
        <button class="toggle-button" onclick="removeAllChildren('chat-container');usageStats.resetConversation();" title="Clear the Chat Conversation">Clear Chat</button>
        <button class="toggle-button" onclick="toggleVisibility('sidebar-codeView')" title="Toggle Code View sidebar">Code</button>
        <button class="toggle-button" onclick="toggleVisibility('sidebar-functionDef')" title="Toggle functionDef sidebar">functionDef</button>
        <button class="toggle-button" onclick="toggleVisibility('sidebar-roleSystem')" title="Toggle system sidebar">system</button>
        <button class="toggle-button" onclick="toggleVisibility('sidebar-settings')" title="Toggle Settings sidebar" id="settingsSideToggleBtn">Settings</button>
      </div>
    </header>

    <div class="page-content">
      <aside class="sidebar sidebar-left sidebar-codeView" title="Code View Sidebar">
        <div class="sidebar-header">
          <h3>Code</h3>
          <div class="sm-buttons-container">
            <button class="update-button" onclick="getCodeView('codeViewInput')" title="Refresh the Code View">refresh</button>
            <button class="clear-button" onclick="clearElementById('codeViewInput')" title="clear Code View">clear</button>
            <button id="optionsCodeToggleBtn" title="Toggle Code View Option Menu Bar" onclick="toggleVisibility('codeViewOptionsContainer');toggleButtonState(this)">options: OFF</button>
            <button class="help-button" onclick="openTablePopup('codeViewHelp')" title="Code View Help">?</button>
            <button class="close-button" onclick="toggleVisibility('sidebar-codeView', 'off')" title="Close Code View sidebar">x</button>
          </div>
        </div>
        <div class="toggle-buttons-container hidden" id="codeViewOptionsContainer">
          <button id="bodyCodeToggleBtn" title="Toggle Endpoint body View (JSON)" onclick="toggleButtonState(this)" data-enabled="false" class="button-enabled">body: OFF</button>
          <button id="responseCodeToggleBtn" title="Toggle Endpoint Last response View (JSON)" onclick="toggleButtonState(this)" data-enabled="false" class="button-enabled">response: OFF</button>
          <button id="statusCodeToggleBtn" title="Toggle Status View (text)" onclick="toggleButtonState(this)" data-enabled="false" class="button-enabled">status: OFF</button>
          <button id="usageCodeToggleBtn" title="Toggle Token Usage Summary (table)" onclick="toggleButtonState(this)" data-enabled="true" class="button-disabled">usage: ON</button>
        </div>
        <div class="sidebar-content">
          <textarea id="codeViewInput" class="codeView-input" placeholder="API Prompt JSON Will Be Displayed Here" title="Code View Display Only"></textarea>
        </div>
      </aside>

      <aside class="sidebar sidebar-left sidebar-functionDef" title="Function Definition Sidebar">
        <div class="sidebar-header">
          <h3>functionDef</h3>
          <div class="sm-buttons-container">
            <button class="clear-button" onclick="clearElementById('functionDefInput')" title="clear functionDef">clear</button>
            <button class="help-button" onclick="openTablePopup('functionDefHelp')" title="functionDef Help">?</button>
            <button class="close-button" onclick="toggleVisibility('sidebar-functionDef', 'off')" title="Close functionDef sidebar">x</button>
          </div>
        </div>
        <div class="sidebar-content">
          <textarea id="functionDefInput" class="functionDef-input" placeholder="Enter function definition JSON" title="Function Definition Input"></textarea>
        </div>
      </aside>

      <aside class="sidebar sidebar-left sidebar-roleSystem" title="System Sidebar">
        <div class="sidebar-header">
          <h3>System</h3>
          <div class="sm-buttons-container">
            <button class="clear-button" onclick="clearElementById('systemInput')" title="clear System Prompt">clear</button>
            <button class="close-button" onclick="toggleVisibility('sidebar-roleSystem', 'off')" title="Close System sidebar">x</button>
          </div>
        </div>
        <div class="sidebar-content">
          <textarea id="systemInput" class="system-input" placeholder="You are a helpful assistant." title="System Input"></textarea>
        </div>
      </aside>

      <main class="conversation-zone" title="Main Conversation Zone">
        <div id="chat-container"></div>
        <div id="chat-interface">
          <button class="tts-button hidden" id="toggleSpeechBtn" onclick="toggleSpeech()">&#128264;</button>
          <textarea id="message-input" placeholder="Enter your message" rows="1" title="Message Input"></textarea>
          <div class="send-button-container" id="sendButtonContainer">
            <button class="send-button" id="sendButton" title="Send Button">Send</button>
            <div class="send-button-indicator" id="sendButtonIndicator"></div>
          </div>
          <div class="chat-loading-container hidden" id="chatLoadingContainer">
            <div class="chat-loading" id="chatLoading" title="Chat Loading Indicator"></div>
          </div>
        </div>
      </main>

      <aside class="sidebar sidebar-right sidebar-settings" title="Settings Sidebar">
        <div class="sidebar-header">
          <h3>Settings</h3>
          <button class="toggle-button hidden" onclick="toggleVisibility('indicatorArea')" title="Toggle indicatorArea">indicatorArea</button>
          <div class="sm-buttons-container">
            <button class="clear-button" onclick="clearLocalStorage()" title="Clear All Hold Settings">clear</button>
            <button class="help-button" onclick="openTablePopup('apiHelp')" title="OpenAI API Parameters Help">?</button>
            <button class="close-button" onclick="toggleVisibility('sidebar-settings', 'off')" title="Close Settings sidebar">x</button>
          </div>
        </div>
        <div class="sidebar-content">
          <div class="parameters-container" id="apiParametersContainer">
            <div class="input-pair">
              <button class="btn" title="Copy setting to hold area" onclick="copyToLocalStorage()">hold config</button>
            </div>

            <div class="input-pair">
              <button class = "hidden" id="extControlsToggleBtn" title="Toggle External Configuration Controls"
                      onclick="toggleVisibility('extControlsContainer');">External Config</button>
            </div>
            <div class="ext-controls-container hidden" id="extControlsContainer">
              <div class="input-pair">
                <button class="btn extConfig" title="Export apis{} JSON" onclick="exportExternalValues('apis')">export apis{}.js localStore</button>
              </div>
              <div class="input-pair">
                <button class="btn extConfig" title="Import import_apis[] JSON" onclick="importExternalValues('apis')">import apis[]</button>
              </div>
            </div>

            <div class="input-pair">
              <div class="api-container"></div>
            </div>
            <div class="input-pair">
              <label for="apiModel">model select:</label>
              <select class="parameter model" id="apiModel" required title="Select Model"></select>
            </div>
            <div class="input-pair">
              <button id="apiSettingsToggleBtn" title="API Settings Toggle Button" onclick="toggleVisibility('apiSettingsContainer')">API Parameters</button>
            </div>


             <div class="api-settings-container hidden" id="apiSettingsContainer"></div>


            <div class="input-pair">
              <button id="ttsToggleBtn" title="Toggle Text to Speech Functionality and Controls"
                      onclick="toggleVisibility('toggleSpeechBtn');toggleVisibility('ttsSettingsContainer');toggleButtonState(this)">Text to Speech: OFF</button>
            </div>
            <div class="tts-settings-container hidden" id="ttsSettingsContainer">
              <div class="input-pair slider-container">
                <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1">
                <input type="text" id="volume">
                <label for="volume">Volume</label>
              </div>
              <div class="input-pair slider-container">
                <input type="range" id="rate-slider" min="0.1" max="10" step="0.1" value="1">
                <input type="text" id="rate">
                <label for="rate">Rate</label>
              </div>
              <div class="input-pair slider-container">
                <input type="range" id="pitch-slider" min="0" max="2" step="0.1" value="1">
                <input type="text" id="pitch">
                <label for="pitch">Pitch</label>
              </div>
              <div class="input-pair">
                <button class="btn hidden" title="Copy TTS setting to hold area" onclick="copyToLocalStorage('.tts')">hold TTS</button>
              </div>
              <div class="separator"></div>
            </div>
            <div class="input-pair">
              <button id="enterToSendBtn" class="button-enabled" data-enabled="true" title="Toggle Use of [Enter] Key to Send" onclick="toggleButtonState(this)">Enter to Send: ON</button>
            </div>
            <div class="input-pair">
              <button id="statusBarToggleBtn" title="Toggle Status Bar View" onclick="toggleVisibility('statusBarText');toggleButtonState(this)">Status Bar: OFF</button>
            </div>
            <div class="input-pair">
              <button class="btn" onclick="openTablePopup('ollamaHelp')" title="Ollama Help">ollama.local Help</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
    <footer class="footer">
      <div class="status-bar-text hidden" id="statusBarText"></div>
    </footer>
    <div class="overlay"></div>
    <div class="popup">
      <div class="popup-header" id="popupHeader"></div>
      <div class="popup-table" id="popupTable"></div>
    </div>
  </div>



<script>
    function testCors(endpoint, timeout) {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          reject('Timeout occurred');
        }, timeout);

        fetch(endpoint, {
          method: 'GET',
          mode: 'cors'
        })
        .then(response => {
          resolve(response.status);
        })
        .catch(error => {
          resolve(error);
        });
      });
    }
</script>

<script>
    let altapis = [];

    function loadAltAPIs() {
      return new Promise((resolve, reject) => {
        altapis = [
          {
            label: "openai.api",
            models: [
              { "model": "gpt-3.5-turbo" },
              { "model": "gpt-3.5-turbo-0125" },
              { "model": "gpt-4o" },
              { "model": "gpt-4o-2024-05-13" },
              { "model": "gpt-4-turbo-2024-04-09" },
              { "model": "gpt-4-0125-preview" },
              { "model": "gpt-4-1106-preview" },
              { "model": "gpt-3.5-turbo-1106" },
              { "model": "gpt-4" },
              { "model": "gpt-4-0613" }
            ]
          }
        ];
        resolve(altapis);
      });
    }
</script>

<script>
    let parameters_apis = [];

    function loadParameters_apis() {
      return new Promise((resolve, reject) => {
        const parameters_apis = [
          {
            label: "openai.api",
            parameters: {
              key: "YOUR_OPEN_AI_API_KEY_GOES_HERE",
              model: "gpt-3.5-turbo-0125",
              temperature: "0.7",
              max_tokens: "",
              top_p: "",
              frequency_penalty: "",
              presence_penalty: ""
            }
          },
          {
            label: "ollama.local",
            parameters: {
              key: "ollama",
              model: "phi3:3.8b-mini-instruct-4k-q4_K_M",
              temperature: "0",
              max_tokens: "",
              top_p: "",
              frequency_penalty: "",
              presence_penalty: ""
            }
          },
          {
            label: "ollama.lab",
            parameters: {
              key: "ollama",
              model: "tinydolphin:1.1b-v2.8-q5_K_M",
              temperature: "0",
              max_tokens: "",
              top_p: "",
              frequency_penalty: "",
              presence_penalty: ""
            }
          }
        ];
        resolve(parameters_apis);
      });
    }
</script>

<script>
    let apis = [];

    function loadAPIs() {
      return new Promise((resolve, reject) => {
        apis = [
          {
            label: "openai.api",
            status: "",
            endpoint: {
              base: "https://api.openai.com",
              check: {
                url: "https://status.openai.com/api/v2/status.json",
                status: 0
              },
              chat: "https://api.openai.com/v1/chat/completions",
              headers: { "Content-Type": "application/json", "Authorization": "Bearer ${endpointKey}" },
              models: "",
              parameters: ""
            }
          },
          {
            label: "ollama.local",
            status: "",
            endpoint: {
              headers: { "Content-Type": "application/json" },
              base: "http://127.0.0.1:11434",
              check: {
                url: "http://127.0.0.1:11434",
                status: 0
              },
              chat: "http://127.0.0.1:11434/v1/chat/completions",
              models: "http://127.0.0.1:11434/api/tags",
              parameters: ""
            }
          },
          {
            label: "ollama.lab",
            status: "",
            endpoint: {
              headers: { "Content-Type": "application/json" },
              base: "http://192.168.1.51:11434",
              check: {
                url: "http://192.168.1.51:11434",
                status: 0
              },
              chat: "http://192.168.1.51:11434/v1/chat/completions",
              models: "http://192.168.1.51:11434/api/tags",
              parameters: ""
            }
          }
        ];
        resolve(apis);
      });
    }
</script>

<script>
    function fetchApiEndpointModels(api) {
      let models = [];
      return fetch(api.endpoint.models, {
        method: 'GET',
        headers: api.endpoint.headers
      })
      .then(response => response.json())
      .then(data => {
      //const models = data.models;  // -t20240516T1328 -
        models = data.models || [];  // +t20240516T1328 - Ensure `models` is an array even if `data.models` is not defined.
        return models;
      })
      .catch(error => {
        console.error("Failed to fetch models:", api.label, error);
        throw error;
      });
    }
</script>

<script>
    function updateApiCardStatus(api) {
        const apiContainer = document.querySelector(".api-container");
        const apiCard = document.createElement("div");
        apiCard.classList.add("api-card", api.status, "btn");
        apiCard.textContent = `${api.label}`;
        apiCard.title = `${api.label} - ${api.status}`;
        apiCard.id = 'card-' + api.label;
        let onclickAction = "selectElementIdFromClass(this.id, 'api-card'); selectApiByLabel(this.id.replace('card-', ''));";
        apiCard.setAttribute("onclick", onclickAction);
        apiContainer.appendChild(apiCard);
    }

    function apisEndpointCheckStatusSet(apis) {
      return Promise.all(apis.map(api => {
        return testCors(api.endpoint.check.url, 2000)
          .then(status => {
          //api.endpoint.check.status = typeof status !== 'number' ? -1 : status; //  -t20240516T1328
            api.endpoint.check.status = typeof status === 'number' ? status : -1;  //  +t20240516T1328
          }).catch(error => {
            console.error('Failed to check status for:', api.label, error);
            api.endpoint.check.status = -1;
          });
      }));
    }
</script>

<script>
function apisStatusSet(apis) {
    return Promise.all(apis.map(api => {
      return new Promise((resolve) => {
        let apiParameters = parameters_apis.find(apiParameters => apiParameters.label === api.label);
        if (apiParameters && !api.parameters) {
          api.parameters = apiParameters.parameters;
        }

        let useMe = { api: [], label: "", source: "" };

        if (useMe.label === "") {
          let localStorage_apis = JSON.parse(localStorage.getItem('apis')) || [];
          try {
            if (localStorage_apis.length) {
              let localStorage_api = localStorage_apis.find(item => item.label === api.label);
              if (localStorage_api) {
                useMe = localStorage_api;
                useMe.label = api.label;
                useMe.source = "localStorage_api";
              }
            }
          } catch (error) {
            console.error('Error while checking localStorage_apis:', error);
          }
        }

        if (useMe.label === "") {
          try {
            if (typeof imported_apis !== 'undefined') {
              if (imported_apis && imported_apis.length > 0) {
                let imported_api = imported_apis.find(item => item.label === api.label);
                if (imported_api) {
                  useMe = imported_api;
                  useMe.label = api.label;
                  useMe.source = "imported_api";
                }
              }
            }
          } catch (error) {
            console.error('Error while checking imported_apis:', error);
          }
        }

        if (useMe.label === "") {
          try {
            if (parameters_apis.length) {
              let parameters_api = parameters_apis.find(item => item.label === api.label);
              if (parameters_api) {
                useMe.parameters = parameters_api.parameters;
                useMe.label = api.label;
                useMe.source = "parameters_api";
              }
            }
          } catch (error) {
            console.error('Error while checking parameters_apis:', error);
          }
        }

        if (useMe.label !== "") {
          api.parameters = useMe.parameters;
        }

        if (api.endpoint.check.status === 200) {
          api.status = "ready";

          if (api.endpoint.models) {
            fetchApiEndpointModels(api).then(models => {
              api.models = models;
              addModelsToModelSelector(api);
              updateApiCardStatus(api);
              if (!firstReadyApiLabel) {
                firstReadyApiLabel = api.label;
              }
              resolve();
            });
          } else {
            let altapi = altapis.find(altapi => altapi.label === api.label);
            if (altapi) {
              api.models = altapi.models;
              addModelsToModelSelector(api);
              updateApiCardStatus(api);
              if (!firstReadyApiLabel) {
                firstReadyApiLabel = api.label;
              }
            }
            resolve();
          }
        } else {
          api.status = "na";
          updateApiCardStatus(api);
          resolve();
        }
      });
    })).then(() => {
      if (firstReadyApiLabel) {
        // document.getElementById('card-' + firstReadyApiLabel).click();
      }
    });
}
</script>

<script>
    let importFileName = '';
    let importFunctionName = '';
    let selectedAPI = [];
    let firstReadyApiLabel = '';
    let statusLineList = '';
    let endpointKey  = '';  // +t20240516T1913

    const selector = document.getElementById('apiModel');
    selector.innerHTML = '';

    loadAltAPIs()
      .then((loadedAltApis) => {
        altapis = loadedAltApis;
        return loadAPIs();
      })
      .then((loadedApis) => {
        apis = loadedApis;
        return loadParameters_apis();
      })
      .then((parameters) => {
        parameters_apis = parameters;
        return apisEndpointCheckStatusSet(apis);
      })
      .then(() => {
        return apisStatusSet(apis);
      })
      .then(() => {
        if (firstReadyApiLabel) {
          let selectedAPI = apis.find(api => api.label === firstReadyApiLabel);
          console.log('set selectedAPI:', selectedAPI);
          document.getElementById('card-' + firstReadyApiLabel).click();
        }
        apiModel.dispatchEvent(new Event('change'));
      })
      .catch((error) => {
        console.error('An error occurred:', error);
      });
</script>


<script src="importData-apis.js" defer></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      populateFromLocalStorage();
      apisFromLocalStorage();

    console.log('ck1 screen toggle selectedAPI::', selectedAPI);
    setTimeout(function() {
      while(selectedAPI.label === '') {
        setTimeout(() => {console.log("Waited 0.1 seconds")}, 100);
      }
      console.log('ch2 screen toggle selectedAPI::', selectedAPI);

      if (!selectedAPI || !selectedAPI.parameters || !selectedAPI.parameters.key || !selectedAPI.parameters.key.trim()) {
        toggleVisibility('sidebar-settings', 'on');
        clickElementById('apiSettingsToggleBtn');
      } else {
        toggleVisibility('sidebar-settings', 'off');
      }
      if (document.getElementById('codeViewInput').value === ''){
        toggleVisibility('sidebar-codeView', 'off');
      } else {
        toggleVisibility('sidebar-codeView', 'on');
      }
      if (document.getElementById('functionDefInput').value === ''){
        toggleVisibility('sidebar-functionDef', 'off');
      } else {
        toggleVisibility('sidebar-functionDef', 'on');
      }
      if (document.getElementById('systemInput').value === ''){
        toggleVisibility('sidebar-roleSystem', 'off');
      } else {
        toggleVisibility('sidebar-roleSystem', 'on');
      }
      endpointKey = (typeof yekKit !== 'undefined' && yekKit) ? yekKit : (selectedAPI && selectedAPI.parameters && selectedAPI.parameters.key ? selectedAPI.parameters.key : '');
      chatReadyCheck('sendButtonIndicator', endpointKey);
    }, 1000);

/*
      window.onload = function() {
        setTimeout(function() {
          let endpointKey = (typeof yekKit !== 'undefined' && yekKit) ? yekKit : (selectedAPI && selectedAPI.parameters && selectedAPI.parameters.key ? selectedAPI.parameters.key : '');
          chatReadyCheck('sendButtonIndicator', endpointKey);
        }, 1000);
      };
*/
      initializeRangeInputs();
    });

  const chatContainer = document.getElementById('chat-container');
  const messageInput = document.getElementById('message-input');
  const sendButton = document.getElementById('sendButton');
  const enterToSendToggle = document.getElementById('enterToSendBtn');

  let ollamaStatus = 'none';
  let statusLine = '';
  let bodyJson = '';
  let lastResponse = {};

//sendButton.addEventListener('click', () => {    // -t20240516T1328 - If calling async functions listener, it should be async itself.
  sendButton.addEventListener('click', async () => {
    const message = messageInput.value.trim();
    if (message != '') {
      appendMessage(message, 'user');
      messageInput.value = '';
      chatSendMessage();
    } else {
      messageInput.value = '';
    }
  });


  messageInput.addEventListener('keydown', (event) => {
    const enterToSendEnabled = enterToSendToggle.getAttribute('data-enabled') === 'true';
    if (enterToSendEnabled && event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      const message = messageInput.value.trim();
      if (message != '') {
        sendButton.click();
      }
    }
  });

  function toggleNav() {
    var nav = document.querySelector('.header nav');
    nav.style.display = (nav.style.display === 'flex') ? 'none' : 'flex';
  }

  function toggleButtonState(buttonElement, labelElementId = null) {
    const labelElement = labelElementId ? document.getElementById(labelElementId) : buttonElement;
    const isEnabled = buttonElement.getAttribute('data-enabled') === 'true';
    const newState = !isEnabled;
    buttonElement.setAttribute('data-enabled', newState.toString());
    const labelBase = labelElement.textContent.replace(': ON', '').replace(': OFF', '').trim();
    labelElement.textContent = `${labelBase}: ${newState ? 'ON' : 'OFF'}`;
    labelElement.classList.toggle('button-enabled', newState);
    labelElement.classList.toggle('button-disabled', !newState);
  }

  function clearElementById(elementId) {
    const element = document.getElementById(elementId);
    element.value = "";
  }

  function removeAllChildren(elementId) {
    var chatContainer = document.getElementById(elementId);
    while (chatContainer.firstChild) {
      chatContainer.removeChild(chatContainer.firstChild);
    }
  }

  function clearLocalStorage(selector) {
    if (selector) {
      let elements = document.querySelectorAll(selector);
      elements.forEach(element => {
        localStorage.removeItem(element.id);
      });
    } else {
      localStorage.clear();
    }
  }

  function copyToLocalStorage(selector) {
    if (selector) {
      let elements = document.querySelectorAll(selector);
      elements.forEach(element => {
        if (element.tagName.toLowerCase() === 'input' || element.tagName.toLowerCase() === 'textarea') {
          localStorage.setItem(element.id, element.value);
        } else if (element.tagName.toLowerCase() === 'select') {
          localStorage.setItem(element.id, element.options[element.selectedIndex].value);
        } else {
          localStorage.setItem(element.id, element.innerHTML);
        }
      });
    } else {
      apisToLocalStorage();
    }
  }

  function apisToLocalStorage() {
    apiModel.dispatchEvent(new Event('change'));
    const apisJson = JSON.stringify(apis, null, 2);
    localStorage.setItem('apis', apisJson);
  }

  function apisFromLocalStorage() {
    const apisJson = localStorage.getItem('apis');
    if (apisJson) {
        apis = JSON.parse(apisJson);
    }
    apiModel.dispatchEvent(new Event('change'));
  }

  function populateFromLocalStorage() {
    for (let i = 0; i < localStorage.length; i++) {
      let key = localStorage.key(i);
      let element = document.getElementById(key);
      if (element) {
        if (element.tagName.toLowerCase() === 'input' || element.tagName.toLowerCase() === 'textarea') {
          element.value = localStorage.getItem(key);
        } else if (element.tagName.toLowerCase() === 'select') {
          let value = localStorage.getItem(key);
          for (let option of element.options) {
            if (option.value === value) {
              option.selected = true;
              break;
            }
          }
        } else {
          element.innerHTML = localStorage.getItem(key);
        }
      }
    }
    apiModel.dispatchEvent(new Event('change'));
  }

  function toggleVisibility(target, status) {
    console.log('toggleVisibility():', target, status);
    const elements = document.getElementById(target) ? [document.getElementById(target)] : document.querySelectorAll('.' + target);
    if (!elements.length) {
      return;
    }
    elements.forEach(element => {
      switch(status) {
        case 'on':
          element.classList.add('visible');
          element.classList.remove('hidden');
          break;
        case 'off':
          element.classList.add('hidden');
          element.classList.remove('visible');
          break;
        default:
          element.classList.toggle('hidden');
          element.classList.toggle('visible');
        break;
      }
    });
  }

  function scrollToBottom(target) {
    const container = document.querySelector(target);
    const parentContainer = container.parentElement;
    container.scrollTop = container.scrollHeight;
    if (parentContainer.scrollHeight > parentContainer.clientHeight) {
      parentContainer.scrollTop = parentContainer.scrollHeight;
    }
  }

  function showChatLoading() {
    document.getElementById('chatLoadingContainer').classList.remove('hidden');
    document.getElementById('sendButtonContainer').classList.add('hidden');
  }

  function hideChatLoading() {
    document.getElementById('chatLoadingContainer').classList.add('hidden');
    document.getElementById('sendButtonContainer').classList.remove('hidden');
  }

  function appendMessage(content, className) {
    const messageDiv = createChatMessageElement(content, className);
    messageDiv.classList.add('message', className);
    chatContainer.prepend(messageDiv);
    scrollToBottom('.conversation-zone');
  }

  async function buildFunctions() {
    const functions = [];
    let content = document.getElementById('functionDefInput').value;
    try {
      let parsedContent = JSON.parse(content);
      functions.push(parsedContent);
    } catch (error) {
    }
    return functions;
  }

async function buildMessages() {
    let messages = [];
    let content = document.getElementById('systemInput').value;
    let role = 'system';

    if (content !== "") {
      messages.push({ role, content });
    }

    let section = document.getElementById('chat-container');
    if (!section) {
      console.error('chat-container element not found');
      return messages;
    }

    let messageElements = section.querySelectorAll('.message-element');
    messageElements.forEach((element) => {
      role = element.querySelector('.role-indicator').textContent;
      content = element.querySelector('.content.raw').textContent;
      messages.unshift({ role, content });
    });

    return messages;
}

async function newConversation() {
    let startTime, endTime;
    let functions = [];
    let messages = [];
    let body = {};
    let model = selectedAPI.parameters.model;

    let temperature = parseFloat(selectedAPI.parameters.temperature);
    let max_tokens = parseInt(selectedAPI.parameters.max_tokens);
    let top_p = parseFloat(selectedAPI.parameters.top_p);
    let frequency_penalty = parseFloat(selectedAPI.parameters.frequency_penalty);
    let presence_penalty = parseFloat(selectedAPI.parameters.presence_penalty);

    if (model && model !== "") { body = { ...body, model }; }
    if (temperature && temperature > 0) { body = { ...body, temperature }; }
    if (max_tokens && max_tokens > 0) { body = { ...body, max_tokens }; }
    if (top_p && top_p > 0) { body = { ...body, top_p }; }
    if (frequency_penalty && frequency_penalty > 0) { body = { ...body, frequency_penalty }; }
    if (presence_penalty && presence_penalty > 0) { body = { ...body, presence_penalty }; }

    functions = await buildFunctions();
    messages = await buildMessages();

    if (functions && functions.length > 0) {
        body = { ...body, function_call: "auto" };
    }
    if (messages.length > -1) {
        body = { ...body, messages };
    }
    if (functions.length > 0) {
        body = { ...body, functions };
    }

    return body;
}

function chatReadyCheck(elementId, ...variables) {
    const element = document.getElementById(elementId);
    let isReady = variables.some(variable => typeof variable !== 'undefined' && variable !== 'notDefined' && variable !== '');
    element.classList.toggle('ready', isReady);
}

async function chatSendMessage() {
    let endpointURL = selectedAPI.endpoint.chat;
    let headers = selectedAPI.endpoint.headers;
    let data;
    let message = {};
    let content = '';
    let role = '';
    let passCount = 0;

    bodyJson = await newConversation();
    let endpointKey = (typeof yekKit !== 'undefined' && yekKit) ? yekKit : (selectedAPI.parameters.key || '');
    chatReadyCheck('sendButtonIndicator', endpointKey);
    usageStats.resetChat();

    while (true) {
        showChatLoading();
        passCount += 1;
        if (passCount > 4) {
            throw new Error('Too many function calls');
        }

        startTime = Date.now();

        if (endpointURL.startsWith("https:")) {
            headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${endpointKey}` };
        }

        const response = await fetch(endpointURL, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(bodyJson)
        });

        data = await response.json();
        endTime = Date.now();
        lastResponse = data;

        if (data.error) {
            console.error('API Error:', data.error.message);
            alert(`API Error: ${data.error.message}`);
            toggleVisibility('sidebar-settings', 'on');
            break;
        } else {
            statusLine = createStatusLine(data);
            document.getElementById('statusBarText').innerText = statusLine;
            usageStats.updateUsage(data);
        }

        role = data.choices[0].message.role;
        content = data.choices[0].message.content || "";
        bodyJson.messages.push({ role, content });

        if (data.choices[0].finish_reason == 'function_call') {
            message = data.choices[0].message;
            message = replaceNullWithEmptyString(message);
            bodyJson.messages.push(message);

            let functionName = data.choices[0].message.function_call.name;
            let functionArgs = Object.values(JSON.parse(data.choices[0].message.function_call.arguments));

          //let functionResponse = await apiCallFunction(functionName, ...functionArgs); //  -t20240516T1328
            let functionResponse = await apiCallFunction(functionName, ...functionArgs) || '{"status": "success", "message": "The operation completed successfully, no errors were reported."}'; //  +t20240516T1328
            functionResponse = JSON.stringify(JSON.parse(functionResponse).content);
            bodyJson.messages.push({ role: 'function', name: functionName, content: functionResponse });
        } else {
            break;
        }
    }

    hideChatLoading();

    if (!data.error) {
        const botReply = data.choices[0].message.content;
        appendMessage(botReply, 'assistant');
    }
}

/*  // +t20240520T2103 */

function createChatMessageElement(message, source) {
    const date = new Date();
    const msgId = "msgId" + date.toISOString().replace(/[:\-Z]/g, '').replace(/\./g, '_');
    const formats = [];
    const messageElement = document.createElement('div');
    messageElement.classList.add('message-element');
    messageElement.id = msgId;

    // Create and append header
    const headerElement = createHeaderElement(source);
    messageElement.appendChild(headerElement);

    // Parse and format content
    const contentFormats = parseAndFormatContent(message);
    contentFormats.forEach(format => {
        messageElement.appendChild(format.element);
        formats.push(format.type);
    });

    // Populate message type selector
    const messageTypeSelector = headerElement.querySelector('.message-type-selector');
    populateMessageTypeSelector(messageTypeSelector, formats);
    setupMessageTypeSelectorHandler(messageTypeSelector, messageElement);

    // Show the first format by default
    if (formats.length > 1) {
        messageTypeSelector.classList.add('visible');
        messageTypeSelector.selectedIndex = 1;
    } else {
        contentFormats[0].element.classList.add('visible');
    }

    messageTypeSelector.selectedIndex = 0;
    messageTypeSelector.dispatchEvent(new Event('change'));
    return messageElement;
}

function createHeaderElement(source) {
    const headerElement = document.createElement('div');
    headerElement.classList.add('chat-message-header');

    const roleIndicator = document.createElement('span');
    roleIndicator.classList.add('role-indicator');
    roleIndicator.textContent = source;
    headerElement.appendChild(roleIndicator);

    const altIndicator = document.createElement('span');
    altIndicator.classList.add('alt-indicator');
    altIndicator.textContent = selectedAPI.parameters.model || 'no model selected';
    headerElement.appendChild(altIndicator);

    const messageTypeSelector = document.createElement('select');
    messageTypeSelector.classList.add('message-type-selector');
    headerElement.appendChild(messageTypeSelector);

    const removeButton = document.createElement('button');
    removeButton.classList.add('remove-message-button');
    removeButton.textContent = '-';
    removeButton.onclick = () => headerElement.parentElement.remove();
    headerElement.appendChild(removeButton);

    return headerElement;
}
</script>


<script>
  function parseAndFormatContent(message) {
    const formats = [];

    // Add plain text format
    const textContentContainer = createContentElement('div', 'text', message);
    formats.push({ element: textContentContainer, type: 'text' });
    
    // Add raw format
    const rawContentContainer = createContentElement('pre', 'raw', message);
    formats.push({ element: rawContentContainer, type: 'raw' });

    // Add code formatted container if applicable
    if (message.startsWith('```') && message.endsWith('```')) {
      console.log('building code codeContent:', 'codeFormattedContainer');
      const codeContent = message.slice(3, -3).trim();
      const codeFormattedContainer = createContentElement('pre', 'code', codeContent);
      formats.push({ element: codeFormattedContainer, type: 'code' });
    } else if (message.includes('```')) {
      console.log('building xcode:', 'xcodeFormattedContainer');
      const parsedData = extractAndRenderContentBlocks(message);
      let xcodeFormattedContainer = document.createElement('div');
      xcodeFormattedContainer = parsedData;
      xcodeFormattedContainer.classList.add('content', 'xcode');
      console.log('xcodeFormattedContainer:', xcodeFormattedContainer);
      formats.push({ element: xcodeFormattedContainer, type: 'xcode' });
    } else {
      console.log('NO code blocks found:');
    };

    // Add JSON format if applicable
    try {
      const parsedMessage = JSON.parse(message);
      const jsonFormattedContainer = createContentElement('pre', 'json', JSON.stringify(parsedMessage, null, 2));
      formats.push({ element: jsonFormattedContainer, type: 'json' });
    } catch (error) {
      // Not JSON
    }

    // Add multiline text format if applicable
    if (message.includes('\n')) {
      const textFormattedContainer = createContentElement('pre', 'textn', message);
      formats.push({ element: textFormattedContainer, type: 'textn' });
    }

   // Add HTML/markup format if applicable
    if (message.startsWith('<') && message.endsWith('>')) {
      const htmlTextViewContainer = createContentElement('pre', 'htmltxt', message);  // isHTML should be false
      formats.push({ element: htmlTextViewContainer, type: 'htmltxt' });

      const htmlRenderedViewContainer = createContentElement('div', 'htmlrnd', message, true);  // isHTML should be true
      formats.push({ element: htmlRenderedViewContainer, type: 'htmlrnd' });
    } else if (message.startsWith('# ')) {
      const markupFormattedContainer = createContentElement('div', 'markup', message, true);  // isHTML should be true
      formats.push({ element: markupFormattedContainer, type: 'markup' });
    }

/*    
    // Add HTML format if message contains ```html
    if (message.includes('```html')) {
      const htmlCodeBlock = message.match(/```html([\s\S]*?)```/);
      if (htmlCodeBlock) {
        const htmlContent = htmlCodeBlock[1].trim();
        const htmlTextViewContainer = createContentElement('pre', 'html-text', htmlContent);
        formats.push({ element: htmlTextViewContainer, type: 'html-text' });

        const htmlRenderedViewContainer = createContentElement('div', 'html-rendered', htmlContent, true);  // isHTML should be true
        formats.push({ element: htmlRenderedViewContainer, type: 'html-rendered' });
      }
    }    
    // Add HTML/markup format if applicable
    if ((message.startsWith('<') && message.endsWith('>')) || message.startsWith('# ')) {
      const isHTML = message.includes('<html>');
      const htmlFormattedContainer = createContentElement('div', isHTML ? 'html' : 'markup', message, true);
      formats.push({ element: htmlFormattedContainer, type: isHTML ? 'html' : 'markup' });
    }
*/
    
    return formats;
  }

  
    function createContentElement(tag, className, content, isHTML = false) {
    console.log('createContentElement():', tag, className);

    // Determine if content is HTML or plain text
    const isHTMLString = typeof content === 'string' && /<\/?[a-z][\s\S]*>/i.test(content);
      
    const element = document.createElement(tag);
    element.classList.add('content', className);

    console.log('...isHTML:', isHTML, content);
    if (isHTML) {
      element.innerHTML = content;
    } else {
      element.textContent = content;
    };

    if (className != 'xcode') {
      element.addEventListener('click', function () {
        document.querySelectorAll('.selected').forEach(ta => ta.classList.remove('selected'));
        this.classList.add('selected');
      });
    };
    return element;
  }
  
  

// +c20240521T1300  
function findCodeBlocks(input) {
  if (typeof input !== 'string') {
    throw new TypeError('Input must be a string');
  }
  const codeBlockRegex = /```(.*?)\n([\s\S]*?)```/g;
  const parsedBlocks = [];
  let lastIndex = 0;
  let match;
  while ((match = codeBlockRegex.exec(input)) !== null) {
    // Extract and add the text before the current code block
    const precedingText = input.slice(lastIndex, match.index).trim();
    if (precedingText) {
      parsedBlocks.push({ codeType: 'text', content: precedingText });
    }
    // Extract code type and content from match
    const codeType = match[1].trim();
    const codeContent = match[2].trim();
    parsedBlocks.push({ codeType, content: codeContent });

    // Update lastIndex to the end of the current match
    lastIndex = codeBlockRegex.lastIndex;
  }
  // Add any remaining text after the last code block
  const remainingText = input.slice(lastIndex).trim();
  if (remainingText) {
    parsedBlocks.push({ codeType: 'text', content: remainingText });
  }
  return parsedBlocks;
}
</script>
    
  
<script>
  function extractAndRenderContentBlocks(message = null) {
    // Retrieve input message or get value from the input element by default
    const messageInput = message || document.getElementById('input').value;

    // Parse the message to identify text and code blocks
    const contentBlocks = findCodeBlocks(messageInput);

    // Create a container for the content blocks
    const contentContainer = document.createElement('div');
    contentContainer.innerHTML = '';

    // Iterate through each content block and create appropriate HTML elements
    contentBlocks.forEach(block => {
      const contentElement = document.createElement('div');
      contentElement.classList.add('content-block');
      
      if (block.codeType === 'text') {
        // For text blocks, simply set the text content
        contentElement.textContent = block.content;
      } else {
        // For code blocks, create a framed element with copy and toggle buttons
        const frame = document.createElement('div');
        frame.classList.add('code-frame');
        
        const preElement = document.createElement('pre');
        preElement.textContent = block.content;
        
        const codeElement = document.createElement('div');
        codeElement.innerHTML = block.content;

        // Create copy button
        const copyButton = document.createElement('button');
        copyButton.textContent = 'copy';
        copyButton.classList.add('copy-button');
        copyButton.addEventListener('click', () => {
          navigator.clipboard.writeText(block.content)
            .then(() => alert('Code copied to clipboard!'))
            .catch(err => console.error('Failed to copy text: ', err));
        });

        // Create toggle button
        const toggleButton = document.createElement('button');
        toggleButton.textContent = 'view';
        toggleButton.classList.add('toggle-button');
        let isCodeView = true;
        toggleButton.addEventListener('click', () => {
          if (isCodeView) {
            frame.replaceChild(codeElement, preElement);
          } else {
            frame.replaceChild(preElement, codeElement);
          }
          isCodeView = !isCodeView;
        });

        // Append buttons and pre element to the frame
        const buttonContainer = document.createElement('div');
        buttonContainer.classList.add('button-container');
        buttonContainer.appendChild(copyButton);
        buttonContainer.appendChild(toggleButton);

        frame.appendChild(buttonContainer);
        frame.appendChild(preElement);
        
        // Append frame to the content element
        contentElement.appendChild(frame);
      }
      
      // Append the created element to the content container
      contentContainer.appendChild(contentElement);
    });

    // Return the content container with all the blocks appended
    return contentContainer;
  }
</script>
    
    
<script>
  function populateMessageTypeSelector(selector, formats) {
    formats.forEach(format => {
        const option = document.createElement('option');
        option.value = format;
        option.textContent = format.toUpperCase();
        selector.appendChild(option);
    });
  }

  function setupMessageTypeSelectorHandler(selector, messageElement) {
    selector.onchange = function () {
        const selectedFormat = this.value;
        const contentContainers = messageElement.querySelectorAll('.content');
        contentContainers.forEach(container => {
            container.classList.toggle('visible', container.classList.contains(selectedFormat));
        });
    };
  }
  
  
  
async function apiCallFunction(functionName, ...args) {
    let defaultResult = '{"status": "success", "message": "The operation completed successfully, no errors were reported."}';
    let response = {};
    if (typeof window[functionName] === 'function') {
        let functionResult = window[functionName](...args);
        let content = functionResult || defaultResult;
        try {
            content = JSON.stringify(JSON.parse(content));
        } catch (error) {
            console.log('--content is not valid JSON:', error);
        }
        response = { role: "function", name: functionName, content };
    } else {
        console.log('Function not found:', functionName);
    }
    return JSON.stringify(response, null, 2);
}

function replaceNullWithEmptyString(obj) {
    for (var key in obj) {
        if (obj[key] === null) {
            obj[key] = "";
        } else if (typeof obj[key] === 'object') {
            obj[key] = replaceNullWithEmptyString(obj[key]);
        }
    }
    return obj;
}

async function getCodeView(elementId) {
    let textContent = {
        body: "",
        response: "",
        status: "",
        usage: ""
    };

    const showBody = document.getElementById('bodyCodeToggleBtn').getAttribute('data-enabled') === 'true';
    const showResponse = document.getElementById('responseCodeToggleBtn').getAttribute('data-enabled') === 'true';
    const showStatus = document.getElementById('statusCodeToggleBtn').getAttribute('data-enabled') === 'true';
    const showUsage = document.getElementById('usageCodeToggleBtn').getAttribute('data-enabled') === 'true';

    const element = document.getElementById(elementId);
    element.value = "";

    let content = await newConversation();
    textContent.body = "----- Body -----\n" + JSON.stringify(content, null, 2) + "\n";
    textContent.response = "----- Response -----\n" + JSON.stringify(lastResponse, null, 2) + "\n";
    textContent.status = "----- Status -----\n" + statusLineList + "\n";
    textContent.usage = "----- Usage -----\n" + JSON.stringify(usageStats, null, 2) + "\n";

    if (showBody) element.value += textContent.body;
    if (showResponse) element.value += textContent.response;
    if (showStatus) element.value += textContent.status;
    if (showUsage) element.value += textContent.usage;
}

function setLeftSidebars() {
    let content =
`{
  "name": "sendEmail",
  "description": "Constructs a mailto link to send an email to the specified recipient with a subject and content.",
  "parameters": {
    "type": "object",
    "properties": {
      "emailTo": {
      "type": "string",
      "description": "The email address of the recipient."
    },
    "subject": {
      "type": "string",
      "description": "The subject line of the email."
    },
    "content": {
      "type": "string",
      "description": "The body content of the email."
    }
    },
    "required": ["emailTo", "subject", "content"]
  }
}`;
    document.getElementById("functionDefInput").value = content;
}

function sendEmail(emailTo, subject, content) {
    var link = "mailto:" + encodeURIComponent(emailTo)
               + "?subject=" + encodeURIComponent(subject)
               + "&body=" + encodeURIComponent(content);
    window.location.href = link;
}
</script>

<script>
  function openTablePopup(tableId) {
    var popup = document.querySelector('.popup');
    var overlay = document.querySelector('.overlay');
    var popupHeader = document.getElementById('popupHeader');
    var popupTable = document.getElementById('popupTable');

    if (tableId === 'apiHelp') {
      popupHeader.textContent = 'API Parameters Help';
      popupTable.innerHTML = `
        <table>
          <tr>
            <th>Setting</th>
            <th>Description</th>
            <th>Range</th>
            <th>Default Value</th>
            <th>Suggested Value</th>
          </tr>
          <tr>
            <td>API Key</td>
            <td>Unique identifier for accessing OpenAI's API</td>
            <td>N/A</td>
            <td>N/A</td>
            <td>N/A</td>
          </tr>
          <tr>
            <td>Model</td>
            <td>Determines the language model used for text generation</td>
            <td>N/A</td>
            <td>N/A</td>
            <td>N/A</td>
          </tr>
          <tr>
            <td>Temperature</td>
            <td>Controls randomness of generated text</td>
            <td>0.0 to 1.0</td>
            <td>0.7</td>
            <td>0.5</td>
          </tr>
          <tr>
            <td>Top_p</td>
            <td>Controls diversity of generated text by considering most probable tokens</td>
            <td>0.0 to 1.0</td>
            <td>0.9</td>
            <td>0.7</td>
          </tr>
          <tr>
            <td>Frequency Penalty</td>
            <td>Discourages repetitive words in generated text</td>
            <td>0.0 to 1.0</td>
            <td>0.0</td>
            <td>0.3</td>
          </tr>
          <tr>
            <td>Presence Penalty</td>
            <td>Discourages specific tokens in generated text</td>
            <td>0.0 to 1.0</td>
            <td>0.0</td>
            <td>0.1</td>
          </tr>
          <tr>
            <td>Stop Sequence</td>
            <td>Indicates when the generation process should stop</td>
            <td>N/A</td>
            <td>None</td>
            <td>Customized</td>
          </tr>
        </table>
      `;
    } else if (tableId === 'functionDefHelp') {
      popupHeader.textContent = 'functionDef Help';
      popupTable.innerHTML = `
        <table>
          <tr>
            <th>function</th>
            <th>functionDef</th>
          </tr>
          <tr>
            <td>sendEmail()</td>
            <td onclick="setLeftSidebars()">click [here] to load sample</br></br>when this JSON{} is present in the functionDef sidebar it is added to the prompt functions[] and provides a template for the bot to use the function sendEmail()</br></br>This should allow the bot to open your email application and populate it.</td>
          </tr>
        </table>
      `;
    } else if (tableId === 'ollamaHelp') {
      popupHeader.textContent = 'promptGenAI - Ollama Help';
      popupTable.innerHTML = `
        <style>
          p, ul, ol {
            margin-top: .8em;
            margin-left: .8em;
            margin-right: .8em;
          }
          li {
            margin-left: 1.6em;
          }
          code {
            background-color: #f4f4f4;
            padding: 2px 5px;
            border-radius: 3px;
          }
        </style>
        <p><strong>CORs ERRORS and why LOADED MODELS DISAPPEAR (A little insight)</strong></p>
        <ul>
          <li>Default ollama model path is based on username.</li>
          <li>Default install <code>ollama serve</code> is running under userId:ollama.</li>
          <li>When <code>ollama serve</code> is stopped and restarted, it will be running under your userId NOT userId:ollama.</li>
          <li>You will not see the models loaded under a different userId (e.g., ollama) unless you set the OLLAMA_MODELS to point to the userId's models path.</li>
        </ul>
        <p><strong>The 2-steps below will bypass the CORS and point to the 'missing' ollama models:</strong></p>
        <ol>
          <li>Stop the ollama service:<br><code>systemctl stop ollama</code></li>
          <li>Restart ollama serve with parameters to bypass CORS, use default http:port and 'ollama' model path:<br><code>OLLAMA_ORIGINS=* OLLAMA_HOST=127.0.0.1:11434 OLLAMA_MODELS=/usr/share/ollama/.ollama/models ollama serve</code></li>
        </ol>
        <p><strong>Ollama default install values:</strong></p>
        <ul>
          <li>Host:Port - <code>OLLAMA_HOST=127.0.0.1:11434</code></li>
          <li>Model location - <code>OLLAMA_MODELS=/usr/share/ollama/.ollama/models</code></li>
          <li>Origins - <code>OLLAMA_ORIGINS= (empty)</code></li>
        </ul>
        <p><strong>To bypass the following errors (these are browser side errors not ollama errors):</strong></p>
        <ul>
          <li>Cross-Origin Request Blocked (CORS error)</li>
          <li>Access-Control-Allow-Origin</li>
        </ul>
        <p>This typically occurs when not using a server where ollama and the browser are on localhost but different users.</p>
        <ul>
          <li>Use - <code>OLLAMA_ORIGINS=*</code></li>
        </ul>
        <p><strong>Curl Statements:</strong></p>
        <ul>
          <li>Install or Update Ollama:</li>
          <code>curl -fsSL https://ollama.com/install.sh | sh</code>
          <br><br>
          <li>Get list of model tags available to active address:port (JSON):</li>
          <code>curl http://127.0.0.1:11434/api/tags</code>
          <br><br>
          <li>Pull an ollama model (or update a model)</li>
          <code>curl http://127.0.0.1:11434/api/pull -d '{"name": "tinydolphin:1.1b-v2.8-q5_K_M"}'</code>
          <br><br>
        </ul>
        <p><em>Disclaimer: The information provided here is for general informational purposes only. All information on the site is provided in good faith, however, we make no representation or warranty of any kind, express or implied, regarding the accuracy, adequacy, validity, reliability, availability, or completeness of any information on the site.</em></p>
      `;
    }

    popup.style.display = 'block';
    overlay.style.display = 'block';
  }

  document.querySelector('.overlay').addEventListener('click', function() {
    document.querySelector('.popup').style.display = 'none';
    document.querySelector('.overlay').style.display = 'none';
  });

  function findCodeBlocks(input) {
    let regex = /```([\s\S]*?)```/g;
    let codeBlocks = [];
    let lastIndex = 0;
    let match;

    while ((match = regex.exec(input)) !== null) {
      let associatedText = input.substring(lastIndex, match.index).trim();
      if (associatedText) {
        codeBlocks.push({ codeType: 'text', content: associatedText });
      }
      let codeType = match[0].match(/```(.*?)\n/)[1].trim();
      let codeContent = match[0].replace(/```(.*?)\n([\s\S]*?)```/, '$2').trim();
      codeBlocks.push({ codeType, content: codeContent });
      lastIndex = regex.lastIndex;
    }
    if (lastIndex < input.length) {
      let remainingText = input.substring(lastIndex).trim();
      if (remainingText) {
        codeBlocks.push({ codeType: 'text', content: remainingText });
      }
    }
    return codeBlocks;
  }

</script>

<script>
  // TEXT TO SPEECH
  document.getElementById('volume').value = localStorage.getItem('volume') || 1;
  document.getElementById('rate').value = localStorage.getItem('rate') || 1;
  document.getElementById('pitch').value = localStorage.getItem('pitch') || 1;

  function toggleSpeech() {
    var selectedElement = document.querySelector('.selected');
    if (selectedElement) {
      var text;
      if (selectedElement.tagName === 'TEXTAREA' || selectedElement.tagName === 'INPUT') {
        text = selectedElement.value;
      } else {
        text = selectedElement.textContent;
      }
      var speech = new SpeechSynthesisUtterance(text);
      speech.volume = document.getElementById('volume').value;
      speech.rate = document.getElementById('rate').value;
      speech.pitch = document.getElementById('pitch').value;
      if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
      } else {
        window.speechSynthesis.speak(speech);
      }
    } else {
      alert("Please select a text to convert to speech");
    }
  }

  function stopSpeech() {
    window.speechSynthesis.cancel();
  }

  function toggleTtsSettings() {
    var settingsContent = document.getElementById("settingsContent");
    settingsContent.style.display = settingsContent.style.display === "block" ? "none" : "block";
  }
</script>

<script>
  function initializeRangeInputs() {
    const rangeInputs = document.querySelectorAll('input[type="range"]');

    function updateRelatedElement(source, target) {
      const value = source.value;
      target.value = value;
    }

    rangeInputs.forEach(rangeInput => {
      rangeInput.addEventListener('input', function() {
        const relatedInputId = this.id.replace('-slider', '');
        const relatedInput = document.getElementById(relatedInputId);
        updateRelatedElement(this, relatedInput);
      });

      const relatedNumberInputId = rangeInput.nextElementSibling.id;
      const relatedNumberInput = document.getElementById(relatedNumberInputId);
      relatedNumberInput.addEventListener('input', function() {
        if (this.value < +rangeInput.min) this.value = rangeInput.min;
        if (this.value > +rangeInput.max) this.value = rangeInput.max;
        updateRelatedElement(this, rangeInput);
      });
    });

    rangeInputs.forEach(rangeInput => {
      rangeInput.dispatchEvent(new Event('input'));
    });
  }
</script>

<script>
  function createStatusLine(response) {
    const createdDate = new Date(response.created * 1000);
    const elapsedSeconds = (endTime - startTime) / 1000;
    const statusAPI = (selectedAPI.parameters.key.slice(-4) ?? "");
    const statusDTS = createdDate.toISOString().replace(/[:T-]/g, "").slice(0, 14);
    let statusParts = [];

    function traverseAndCollect(obj, path) {
      for (let key in obj) {
        if (obj.hasOwnProperty(key) && key !== 'choices') {
          let newPath = path ? `${path}.${key}` : key;
          if (typeof obj[key] === 'object' && obj[key] !== null) {
            traverseAndCollect(obj[key], newPath);
          } else {
            statusParts.push(`${newPath}: ${obj[key]}`);
          }
        }
      }
    }

    traverseAndCollect(response, '');

    let statusLine = statusParts.join(', ').replace(/\s+/g, '').replace(/,/g, ' |').replace(/usage\./g, '');
    statusLine += `|API:${statusAPI} |DTS:${statusDTS}_${elapsedSeconds}`;
    statusLineList += '\n' + statusLine;
    return statusLine;
  }
</script>

<script>
  const usageStats = {
    last: { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 },
    chat: { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 },
    conversation: { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 },
    session: { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 },

    updateUsage: function(response) {
      this.last = response.usage;
      this.chat.prompt_tokens += response.usage.prompt_tokens;
      this.chat.completion_tokens += response.usage.completion_tokens;
      this.chat.total_tokens += response.usage.total_tokens;
      this.conversation.prompt_tokens += response.usage.prompt_tokens;
      this.conversation.completion_tokens += response.usage.completion_tokens;
      this.conversation.total_tokens += response.usage.total_tokens;
      this.session.prompt_tokens += response.usage.prompt_tokens;
      this.session.completion_tokens += response.usage.completion_tokens;
      this.session.total_tokens += response.usage.total_tokens;
    },

    resetLast: function() {
      this.last = { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
    },

    resetChat: function() {
      this.resetLast();
      this.chat = { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
    },

    resetConversation: function() {
      this.resetChat();
      this.conversation = { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
    },

    resetSession: function() {
      this.resetConversation();
      this.session = { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
    },
  };
</script>

<script>
  function jsonToHtmlTable(jsonData, axis) {
    const keys = Object.keys(jsonData);
    const subKeys = Object.keys(jsonData[keys[0]]);

    let table = document.createElement('div');
    table.className = 'json-table';

    let header = document.createElement('div');
    header.className = 'json-table-header';
    if (axis === 'rows') {
      header.appendChild(document.createElement('div'));
      subKeys.forEach(subKey => {
        let cell = document.createElement('div');
        cell.textContent = subKey;
        header.appendChild(cell);
      });
    } else {
      keys.forEach(key => {
        let cell = document.createElement('div');
        cell.textContent = key;
        header.appendChild(cell);
      });
    }
    table.appendChild(header);

    if (axis === 'rows') {
      keys.forEach(key => {
        let row = document.createElement('div');
        row.className = 'json-table-row';
        let headerCell = document.createElement('div');
        headerCell.textContent = key;
        row.appendChild(headerCell);
        subKeys.forEach(subKey => {
          let cell = document.createElement('div');
          cell.textContent = jsonData[key][subKey];
          row.appendChild(cell);
        });
        table.appendChild(row);
      });
    } else {
      subKeys.forEach(subKey => {
        let row = document.createElement('div');
        row.className = 'json-table-row';
        keys.forEach(key => {
          let cell = document.createElement('div');
          cell.textContent = jsonData[key][subKey];
          row.appendChild(cell);
        });
        table.appendChild(row);
      });
    }

    return table;
  }
</script>

<script>
  function localStoreValueByTag(storeValue, tag = '') {
    let timestamp = new Date().getTime();
    let storageKey = `${tag}_${timestamp}`;
    localStorage.setItem(storageKey, storeValue);
    alert(`Data stored successfully!\nstorageKey: ${storageKey}`);
  }

  function localStoreElementContents(elementIds, tag = '') {
    let output = {};
    if (elementIds.length === 0) {
      const indicators = document.querySelectorAll('#indicatorBar .indicator');
      indicators.forEach(indicator => {
        elementIds.push(indicator.id.replace('indicator-', ''))
      })
      elementIds.push("statusBarText");
    }

    elementIds.forEach(id => {
      let element = document.getElementById(id);
      if (element) {
        if (element.tagName === 'INPUT' || element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
          output[id] = element.value;
        } else {
          output[id] = element.innerHTML;
        }
      }
    });
    let jsonString = JSON.stringify(output);
    let timestamp = new Date().getTime();
    let storageKey = `${tag}_${timestamp}`;
    localStorage.setItem(storageKey, jsonString);
    alert('Data stored successfully!');
  }

  function retrieveLocalStoredData(tag = '') {
    let storedData = {};
  //for (let i = 0; i < localStorage.length; i++) {    // -t20240516T1328 - replaced with Object.keys
    Object.keys(localStorage).forEach((key) => {
      let storageKey = localStorage.key(i);
      if (storageKey.startsWith(tag)) {
        let storedItem = localStorage.getItem(storageKey);
        try {
          let data = JSON.parse(storedItem);
          storedData[storageKey] = data;
        } catch (e) {
          storedData[storageKey] = storedItem;
        }
      }
    })
    const jsonString = JSON.stringify(storedData, null, 2);

    navigator.clipboard.writeText(jsonString)
      .then(() => alert('Retrieved Data and copied to clipboard: ' + jsonString))
      .catch(err => console.error('Could not copy to clipboard: ', err));
  }

  function downloadLocalStorageData(tag = '') {
    var text = '';
    for (var i = 0; i < localStorage.length; i++) {
      var key = localStorage.key(i);
      var value = localStorage.getItem(key);
      if (key.startsWith(tag) && key != 'apiKey') {
        text += key + ': ' + value + '\n';
      }
    }
    var textFile = new Blob([text], { type: 'text/plain' });
    var downloadLink = document.createElement('a');
    downloadLink.download = 'localStorageData.txt';
    downloadLink.href = window.URL.createObjectURL(textFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
  }
</script>

<script>
  function addModelsToModelSelector(api) {
    const selector = document.getElementById('apiModel');

    const optionDivider = document.createElement('option');
    optionDivider.value = '';
    optionDivider.text = '-- ' + api.label + ' models --';
    selector.appendChild(optionDivider);

    api.models.forEach(model => {
      const option = document.createElement('option');
      option.id = model.model;
      option.value = model.model;
      option.text = model.name || model.model;
      option.classList.add(api.label);
      selector.appendChild(option);
    });

    populateElementId('apiModel', api.parameters.model);
  }
</script>

<script>
  function createParameterInputPair(parameter, value) {
    value = /.*YOUR.*API_KEY.*/.test(value) ? '' : value;  // Clear default API placeholders
    let inputPair = document.createElement('div');
    inputPair.className = 'input-pair';

    let label = document.createElement('label');
    label.htmlFor = 'apix' + parameter.charAt(0).toUpperCase() + parameter.slice(1);
    label.textContent = parameter + ':';
    inputPair.appendChild(label);

    let input = document.createElement('input');
    input.className = 'parameter';
    input.type = 'text';
    input.id = 'apix' + parameter.charAt(0).toUpperCase() + parameter.slice(1);
    input.value = value;
    input.title = parameter.charAt(0).toUpperCase() + parameter.slice(1) + ' Input';
    if (input.id === 'apixKey') {
      input.placeholder = 'Enter API Key';
      input.type = 'password';
    };

    inputPair.appendChild(input);

    document.getElementById('apiSettingsContainer').appendChild(inputPair);
  }
</script>

<script>
  function populateElementId(elementId, value) {
    let element = document.getElementById(elementId);
    if (element) {
      if (element.tagName.toLowerCase() === 'input' || element.tagName.toLowerCase() === 'textarea') {
        element.value = value;
      } else if (element.tagName.toLowerCase() === 'select') {
        for (let option of element.options) {
          if (option.value === value) {
            option.selected = true;
            break;
          }
        }
      } else {
        element.value = value;
      }
    }
  }
</script>

<script>
  function selectElementIdFromClass(elementId, fromClass) {
    var elements = document.getElementsByClassName(fromClass);
    for (var i = 0; i < elements.length; i++) {
      elements[i].classList.remove('selected');
    }
    document.getElementById(elementId).classList.add('selected');
  }
</script>

<script>
  apiModel.addEventListener('change', () => {
    console.log('apiModel Listener:','change');
    let selectedModelClass = '';
    for (let option of apiModel.options) {
      if (option.value === apiModel.value) {
        option.selected = true;
        selectedModelClass = option.className;
        break;
      }
    }

    const containerId = document.getElementById('apiSettingsContainer');
    let parameterIds = containerId.getElementsByClassName('parameter');
    for (let parameterId of parameterIds) {
      let param = parameterId.labels[0].childNodes[0].data.slice(0, -1);
      let value = parameterId.value;
      selectedAPI.parameters[param] = value;
    };

    containerId.innerHTML = '';

    try {
      selectedAPI = apis.find(api => api.label === selectedModelClass);
    } catch {}

    if (selectedAPI) {
      console.log('set selectedAPI:', selectedAPI);
      document.getElementById('apiSettingsToggleBtn').textContent = `${selectedAPI.label} Parameters`;
      selectedAPI.parameters.model = apiModel.value;
      selectElementIdFromClass('card-' + selectedAPI.label, 'api-card');
    } else {
      selectedAPI = '';
      console.log('err selectedAPI:', 'not found');
      document.getElementById('apiSettingsToggleBtn').textContent = `No API found for Model`;
    }

    containerId.innerHTML = '';
    for (let param in selectedAPI.parameters) {
      createParameterInputPair(param, selectedAPI.parameters[param]);
    };
  });
</script>

<script>
  function clickOptionByElementId(elementId, option) {
    var selectElement = document.getElementById(elementId);
    for (var i = 0; i < selectElement.options.length; i++) {
      if (selectElement.options[i].value == option) {
        selectElement.options[i].click();
        break;
      }
    }
  }

  function selectOptionByElementId(elementId, option) {
    var selectElement = document.getElementById(elementId);
    for (var i = 0; i < selectElement.options.length; i++) {
      if (selectElement.options[i].value == option) {
        selectElement.selectedIndex = i;
        break;
      }
    }
    var event = new Event('change');
    selectElement.dispatchEvent(event);
  }

  function getApiByLabel(apiLabel) {
    let api = apis.find(api => apiLabel === apiLabel);
    let model = api.parameters.model;
    selectOptionByElementId('apiModel', model);
    return api;
  }

  function selectApiByLabel(apiLabel) {
    let api = apis.find(api => api.label === apiLabel);
    let model = api.parameters.model;
    selectOptionByElementId('apiModel', model);
  }
</script>

<script>
  function buildImportTemplate(key, value) {
    let importFileName = 'importData-' + key + '.js';
    let importFunctionName = 'importData_' + key;

    let template = `
    if (typeof imported_apis !== 'undefined') {
      console.log('imported_${key}:', 'ALREADY EXISTS');
    } else {
      let imported_${key};
    };

    function ${importFunctionName}(${key}) {
      let exported_${key} = ${value};
      try {
        imported_${key} = JSON.parse(exported_${key});
      } catch {
        imported_${key} = exported_${key};
      }
    }

    ${importFunctionName}();
    `;

    return template;
  }

  function exportExternalValues(tag = '') {
    var text = '';
    for (var i = 0; i < localStorage.length; i++) {
      var key = localStorage.key(i);
      var value = localStorage.getItem(key);
      text += buildImportTemplate(key, value);
      text += '\n';
    }
    var textFile = new Blob([text], { type: 'text/plain' });
    var downloadLink = document.createElement('a');
    downloadLink.download = 'importData-' + tag + '.js';
    downloadLink.href = window.URL.createObjectURL(textFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
  }

  function importExternalValues(tag) {
    importFileName = 'importData-' + tag + '.js';

    if (tag) {
      var script = document.createElement('script');
      script.src = importFileName;
      script.onload = function () {};
      document.head.appendChild(script);
    }
  }
</script>


<script>
  function getUrlParameters() {
    var urlParams = {};
    var queryString = window.location.search.substring(1);
    var params = queryString.split('&');

    for (var i = 0; i < params.length; i++) {
      var pair = params[i].split('=');
      var key = decodeURIComponent(pair[0]);
      var value = decodeURIComponent(pair[1]);
      urlParams[key] = value;
    }
    console.log('urlParams:', urlParams);
    return urlParams;
  }

  function toggleUrlparams() {
    let urlParams = getUrlParameters();
      Object.keys(urlParams).forEach(key => {
        let toggleBtnId = key + 'ToggleBtn';
        let toggleBtn = document.getElementById(toggleBtnId);
        if (toggleBtn) {
          toggleBtn.click();
          console.log(`Clicked button with id ${toggleBtnId} for key ${key} and value ${urlParams[key]}`);
        } else {
          console.log(`Button with id ${toggleBtnId} not found for key ${key} and value ${urlParams[key]}`);
        }
      });
  }
  toggleUrlparams();
</script>


<script>
function waitForValue(checkVariable, interval, timeout) {
  return new Promise((resolve, reject) => {
    let startTime = Date.now();

    const intervalId = setInterval(() => {
      if (checkVariable) {
        clearInterval(intervalId);
        resolve(checkVariable);
      } else if (Date.now() - startTime > timeout) {
        clearInterval(intervalId);
        reject(new Error('Timeout waiting for value'));
      }
    }, interval);
  });
}
/*
//Example usage:
let myVariable;

waitForValue(myVariable, 1000, 5000)
  .then(value => {
    console.log('Value is:', value);
  })
  .catch(error => {
    console.error(error);
  });
*/
</script>

<script>
function markdownToHtml(markdown) {
  let html = markdown
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    .replace(/^\- (.*$)/gim, '<ul><li>$1</li></ul>')
    .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
    .replace(/\*(.*)\*/gim, '<i>$1</i>')
    .replace(/\[(.*?)\]\((.*?)\)/gim, '<a href="$2">$1</a>')
    .replace(/\n$/gim, '<br />');
    // Handle nested lists
    html = html.replace(/<\/ul>\n<ul>/g, '');
  return html.trim();
}
</script>

<script>
  function clickElementById(id) {
    var element = document.getElementById(id);
    if (element) {
      element.click();
    }
  }

//clickElementById('bodyCodeToggleBtn');
//clickElementById('enterToSendBtn');
//clickElementById('statusBarToggleBtn');
//clickElementById('extControlsToggleBtn');

    function parseCodeAndText(input) {
      const regex = /```(.*?)```/gs;
      let output = input.replace(regex, (match) => {
        return `<pre>${match.slice(3, -3)}</pre>`;
      });

      return output;
    }  
</script>
    
<!--
url paramaters
  extControls - toggles id=extControlsToggleBtn - container for export/import apis buttons

-->
    
</body>
</html>