<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>promptGenAI - API Chat Interface</title>
<style>
/* Basic reset */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif, Arial;

}
/* Minimalist grayscale styling */
html, body {
  display: flex;
  flex: 1;
  background: white;
  color: #333;
  height: 100%;
  width: 100%;
  font-size: 1rem;
}
.container {
  display: flex;
  flex: 1;
  flex-direction: column;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 2px;
  margin: 1px;
  overflow: hidden;
  max-width: 100%;
}
.header-nav {
  display: inline-flex;
  padding: 0px;
}
.sidebar {
  display: flex;
  flex-direction: column;
  flex: 0 1 230px;
  padding: 6px;
  border-right: 1px solid #ccc;
  height: 100%;
  border-radius: 6px;
}
.sidebar-right {
  min-width: 400px;
}
.sidebar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}
.sidebar-header h2,
.sidebar-header h3 {
  margin-right: 6px;
}
.sm-buttons-container {
  display: flex;
  flex-direction: row;
  flex-wrap: nowrap;
  width: 100%;
  max-width: 100%;
  align-items: stretch;
  justify-content: flex-end;
  }
.sm-buttons-container * {
  flex: 1;
  max-width: 8em;
  font-size: .8em;
  padding: .3em;
  margin-left: .5em;
  margin-right: 0px;
  background: transparent;
  border: 1px solid #777;
  border-radius: 6px;
  
}
.close-button,
.help-button {
	justify-content: center;
	align-items: center;
	min-width: 2em;
  max-width: 2em;
}

.sidebar-content {
  display: flex;
  flex: 1;
  height: 100%;
  width: 100%;
  overflow-y: auto;
}
.sidebar-content textarea {
  width: 100%;
  height: 100%;
}
/* code view toggle buttons - only so far 20240608 */
.toggle-buttons-container {
  display: inline-flex;
  padding: 6px;
  margin: 0px;
  margin-left: 0px;
}
.toggle-buttons-container * {
  font-size: .8em;
  padding: .3em .6em;
  margin-left: 0px;
  margin-right: .5em;
}
.header-nav .toggle-button {
  min-height: 2.5em;
  padding: 3px;
}
header {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  padding-top: 9px;
  padding-bottom: 9px;
  background-color: #f8f8f8;
  border-bottom: 1px solid #ddd;
  width: 100%;
}
.h2-container-left,
.h2-container-icons-mid,
.h2-container-gap,
.h2-container-controls,
.h2-container-icons-end {
  display: flex;
  flex: 1 0;
  align-items: center;
  margin: 0px;
}
.h2-container-left {
  justify-content: flex-start;
  font-size: 1.7em;
  margin-left: 0px;
  padding-left: 0px;
}
.h2-container-left a {
  margin-left: .5em;
}
.h2-container-controls {
  justify-content: flex-start;
}
.h2-container-controls .api-model {
  font-size: 1em;
  padding: .3em;
  overflow: hidden;
}
.h2-container-gap {
  min-width: 6px;
  max-width: 0px;
}
.h2-container-icons-mid,
.h2-container-icons-end {
  justify-content: flex-end;
  font-size: 1.5em;
  cursor: pointer;
  padding: 0px;
  max-width: 5em;
  margin-left: auto;
}
.h2-container-icons-mid > *,
.h2-container-icons-end > * {
  margin-left: .5em;
}
@media (max-width: 600px) {
  .h2-container-icons-end {
    display: none;
  }
}
@media (min-width: 601px) {
  .h2-container-icons-mid {
    display: none;
  }
}

.page-content {
  display: flex;
  flex: 1;
  height: 100%;
  width: 100%;
  overflow: hidden; /* Prevent scrolling on the main content itself */
}
.conversation-zone {
  display: flex;
  flex-grow: 1;
  flex-direction: column;
  padding: 1em;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  max-width: 100%;
}
#chat-container {
  display: flex;
  flex-grow: 1;
  flex-direction: column-reverse;
  padding: 1em;
  overflow-y: auto;
}
#chat-interface {
  display: flex;
  flex-direction: row;
  margin-top: auto;
  padding-left: 20px;
  padding-right: 20px;
  padding-bottom: 6px;
}
#chatInputControl {
  display: flex;
  flex-direction: row;
}
#message-input {
  display: flex;
  flex-grow: 1;
  resize: vertical;
  padding: 0.5rem;
  border: none;
  border-top: 1px solid #ccc;
  border-bottom: 1px solid #ccc;
  margin-right: 0.5rem;
  padding-bottom: 0rem;
  height: 3em;
  min-width: 5em;
}
.send-button-container {
  display: flex;
  position: relative;
  height: 100%;
  min-height: 100%;
}
.send-button-indicator {
  position: absolute;
  top: .5em;
  right: .5em;
  transform: translate(50%, -50%);
  width: .5em;
  height: .5em;
  border-radius: 50%;
  background-color: lightgrey;
}
.send-button-indicator.ready {
  background-color: var(--icon-bg, #4caf50);
}
.send-button,
.mic-button,
.tts-button,
.vtt-button,
.chat-loading-container {
  width: 4em;
  min-width: 4em;
  height: 100%;
  min-height: 100%;
  border: 1px solid #ccc;
  background-color: #f5f5f5;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}
.tts-button,
.mic-button {
  margin-right: 0.5rem;
}
.chat-loading-container {
  display: flex;
}
.chat-loading {
  display: flex;
  border: .3rem solid #eaeaea;
  border-radius: 50%;
  border-top: .3rem solid #121212;
  width: 1.5em;
  height: 1.5em;
  animation: spin 2s linear infinite;
  padding: .7rem;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.footer {
  padding: 3px;
  background: #f8f8f8;
  border-top: 1px solid #ccc;
}
#statusBarText {
  font-size: .75rem;
  font-style: italic;
  word-break: keep-all;
}

.message {
  border-top: 1px solid #ccc;
  border-bottom: 1px solid #ccc;
  padding-bottom: 6px;
}
.chat-message-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-top: .5em;
  padding-bottom: .5em;
}
.role-indicator,
.alt-indicator {
  margin-right: auto;
  padding-right: 0.5em;
}
.role-indicator {
  text-transform: uppercase;
  color: red;
}
.alt-indicator {
  font-size: 0.9em;
}
.head-gap {
  flex: 1;
}
.msg-controls,
.msg-controls-nav {
  border: 1px solid transparent;
  flex-direction: row;
  padding: 1px;
}
.message-type-selector {
  display: flex;
  margin-left: auto;
  background-color: transparent;
  border: none;
  cursor: pointer;
  justify-content: flex-end;
  text-align: right; /* This aligns text inside the selector to the right */
}
.msg-controls-nav {
  justify-content: space-between;
}
.msg-icon-audio,
.msg-icon-copy,
.msg-icon-nav {
  margin-right: 0.5em;
  padding: 0 0.25em;
  border-radius: 50%;
  border: 2px solid transparent;
  height: 1.7em;
  width: 1.7em;
  min-width: 1.7em;
  cursor: pointer;
  justify-content: center;
}
.msg-icon-copy {
  font-size: 1em;
  padding: 0px;
  margin: 0px;
  border-radius: 3px;
  border: none;
  background-color: transparent;
  color: #333;
}
.message-type-selector {
  font-size: 0.8em;
  padding: 3px;
  margin-left: 0.5em;
  width: auto;
}
.minimize-message-button,
.maximize-message-button,
.remove-message-button {
  margin-left: auto;
  margin-right: 0;
  padding: 0;
  border: 1px solid #333;
}
.code-frame {
  border: 1px solid #ccc;
  padding: 9px;
  position: relative;
  margin-top: 0px;
  margin-bottom: 9px;
}
.content-block .button-container {
  display: flex;
  flex-direction: row;
  justify-content: flex-end;
  margin-top: 1em;
  margin-bottom: 0px;
}
.content-block .button-container > * {
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: transparent;
  font-size: .9em;
  font-family: monospace;
  border-radius: 5px;
  border: 1px solid grey;
  color: grey;
  cursor: pointer;
  padding: 3px;
  margin-left: 0.5em; /* Adjust as needed */
}
.xcode {
  display: flex;
  flex-direction: column;
  background-color: #f0f0f0;
  padding: 10px;
  border-radius: 5px;
  border: 2px solid grey;
}
.content-block .code-frame {
  font-size: smaller;
  font-family: monospace;
}
</style>

<style>
      .input-pair {
        display: flex;
        flex-direction: column;
        max-width: 100%;
        margin: 0;
        padding: 0;
      }
      .input-pair label {
        display: flex;
        font-size: .9em;
      }
      .input-pair.row {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;

      }
      .input-pair.row label {
        width: 34%;
        min-width: 34%;
        margin-right: .5em;

      }
      .input-pair input,
      .input-pair select,
      .input-pair .btn {
        display: flex;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 3px;
        align-items: center;
        justify-content: flex-start;
      }
      .input-pair .btn {
        justify-content: center;
        margin-top: .5em;
      }
      .input-pair.slider-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        width: 100%;
        margin-top: 1em;
      }
      .input-pair.slider-container label {
      	width: 5em;
      }
      .input-pair.slider-container input[type="text"] {
        margin-left: 1em;
        margin-right: 1em;
        width: 3em;
        padding: .5em;
      }
      .input-pair.slider-container input[type="range"] {
    	  flex: 1 1 auto;
		    min-width: 0;
			  padding: .25em;
      }

      .voiceToText-container,
      .vtt-container-sub {
        margin-top: 1em;
        margin-bottom: 1em;
      }
      .vtt-container-sub .input-pair {
        margin-bottom: 1em;
      }
      #voiceToTextLog {
		    font-size: smaller;
		    font-family: monospace;
		    color: #333;
      }

      .separator {
        border-top: 1px solid #ccc;
        margin: .8em 0;
      }

      .end-of-scroll-page-gap {
        height: 90vh;
        width: 100%;
      }

      /* 20240610T1301 good */
      .apis-settings-container .local-storage-buttons {
        display: flex;
        flex-direction: row;
        margin-bottom: 1em;
      }
      .apis-settings-container .local-storage-buttons button {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
        padding: .5em;
        margin: 0px;
        margin-right: .5em;
      }

      .apis-settings-container .api-cards-container {
        display: flex;
        flex-direction: row;
        margin-bottom: 1em;
        justify-content: flex-start;
      }
      .apis-settings-container .api-cards-container > * {
        display: flex;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: .9em;
        height: 6em;
        margin-right: .5em;
        margin-bottom: .5em;
        padding: 9px;
        align-items: flex-start;
        justify-content: flex-start;

      }
      .apis-settings-container .api-card.ready {
        background-color: lightgreen;
      }
      .apis-settings-container .api-card.na {
        background-color: lightcoral;
      }
      .apis-settings-container .api-card.none {
        background-color: lightgray;
      }
      .apis-settings-container .api-card.selected {
        box-shadow: inset 0 0 5px rgba(0,0,0,.5);
        transform: scale(0.98);
        color: #212121;
      }
      .api-parameters-container {
        display: flex;
        flex-direction: column;
        margin-top: 1em;
      }
      .api-parameters-container .input-pair {
        display: flex;
        flex-direction: row;
        max-width: 100%;
        margin-left: .5em;
        margin-right: .5em;
        margin-bottom: 1em;
        align-items: center;
      }
      .api-parameters-container .input-pair label {
        display: flex;
        align-items: flex-start;
        padding: .25em;
        margin-right: 1em;
      }
      
			.api-parameters-container .input-pair .parameter {
			  flex: 1 1 auto;
				  min-width: 0;
			    padding: .25em;
			}
</style>


<style>
   .settings-page {
    display: flex;
    width: 100%;
  }

.settings-page .section {
  margin-bottom: 20px;
  background-color: #f7f7f7;
  padding: 1em;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  position: relative;
}


/* Base styles for small screens (default) */
.sidebar-settings {
  display: flex;
  height: 100%;
  max-height: 100%;
}

.navicon {
  font-size: 2em; /* Larger icon size */
  margin: 0px; /* Adjusted margin */
  filter: brightness(0.4);
  /* background-color: red; */
  /* mix-blend-mode: lighten; */
  opacity: 0.2; /* Making it look like a watermark */
}
.navicon:hover {
  opacity: 100;
}

.settings-page ul {
  list-style: none;
  padding: 0px;
  margin: 0px;

}
.settings-page li {
  margin-bottom: 1em;
  padding: 3px;
  border: 2px solid transparent; /* icon border */
}
.settings-page li:hover {
	border: 2px solid #333;
}


.settings-page .settings-pane-left {
  position: fixed;
  width: 3em;  /* Adjust width to your preference */
  padding: 0px;
  margin: 0px;
  margin-top: 0px;
  background-color: #f4f4f4;
  border-right: 1px solid #ccc;
  overflow-y: auto;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  border-right: 1px solid #ccc;
  border: 1px solid #ccc;
}
.settings-page .settings-pane-left span.label {
  display:none;
}
.settings-page .settings-pane-left a {
  text-decoration: none;
}

.settings-page .settings-pane-right {
  margin-left: 3em;  /* Adjust width to match the width of settings-pane-left */
  flex-grow: 1;
  overflow-y: auto;
  padding: 9px;
  padding-top: 0px;
}

.section-header {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
  margin: 0px;
  padding: 0px;
}

.section h3 {
  margin-top: 0;
  margin-bottom: 1.5em;
  color: #333;
  font-size: 1.5em;
  margin-right: 10px; /* Space between h3 and icon */
}
.section .icon {
  font-size: 1.5em;
}

</style>


<style>
  pre {
    background-color: #f8f8f8;
    padding: 10px;
    border-radius: 5px;
    overflow: auto;
    white-space: pre-wrap; /* Wrap the code */
  }
  .code,
  .json,
  .htmltxt {
    font-size: smaller;
    font-family: monospace;
    color: #333;
  /*font-family: 'Courier New', Courier, monospace;*/
  /*background-color: #f4f4f4;*/
  /*white-space: pre-wrap;  Allows line breaks */
  /*word-wrap: break-word;  Prevents long words from overflowing */
  }
  .htmlrnd {
    flex-direction: column;
    background-color: #f0f0f0;
    padding: 10px;
    border-radius: 5px;
    border: 2px solid #212121;
  }
  .text {
    }
  .textn {
    white-space: pre-wrap;
    word-wrap: break-word;
  }
</style>

<style>
    .json-container {
      display: flex;
      flex: 1;
      flex-direction: column;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 2px;
      margin: 1px;
      overflow: hidden;
      max-width: 100%;
    }
    .json-view .code {
      font-family: 'Courier New', Courier, monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
      background-color: #2e2e2e;
      color: #f8f8f2;
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
    }
    .json-view .key {
      color: #66d9ef; /* Highlighted key color */
    }
    .json-view .string {
      color: #a6e22e;
    }
    .json-view .number {
      color: #ae81ff;
    }
    .json-view .boolean {
      color: #fd971f;
    }
    .json-view .null {
      color: #f92672;
    }
</style>

<style>


@media (max-width: 480px) {
  body {
  	font-size: .7rem;
  }
  .toggle-button {
    padding: 2px;
    margin-right: 0.1rem;
    flex: 1 1 auto;
	  min-width: 0;
/*  flex-shrink: 1; */
  }

.conversation-zone {
	padding: 0;
  border-left: none;
}
	
#chat-interface {
	padding-left: .5em;
	padding-right: .5em;
	padding-bottom: .5em;
}	
  
  .page-content {
    flex-direction: column;
    overflow-y: auto;
  }
  .sidebar {
    order: -1;
    border-right: none;
    border-radius: 0px;
    border: 1px solid #d3d3d3;
    box-shadow: 3px 3px 7px #a9a9a9;
    margin-bottom: 10px;
  }
  .sidebar-right {
    min-width: 0;
  }

.settings-page {
	width: 100%;
}
.settings-page li {
  margin-bottom: .1em;
}
.settings-page .settings-pane-left {
  width: 3em;  /* Adjust width to your preference */
}
.settings-page .settings-pane-right {
  margin-left: 3em;  /* Adjust width to match the width of settings-pane-left */
  max-height: 45vh;
}  
  .codeView-input,
  .functionDef-input,
  .system-input {
    resize: vertical;
    overflow: auto;
    width: 100%;
  }

  .popup {
    width: 90%;
  }
  .header {
    font-size: 14px;
  }
  .content-text {
    font-size: 12px;
    padding: 5px;
  }
  .button {
    padding: 5px 10px;
    font-size: 12px;
  }
}




@media (max-width: 768px) {
  .toggle-button {
    padding: 3px;
    margin-right: .2rem;
    flex-shrink: 1;
  }

.conversation-zone {
	padding: 0;
}
#chat-interface {
	padding-left: .5em;
	padding-right: .5em;
	padding-bottom: .5em;
}	
  
  .page-content {
    flex-direction: column;
    overflow-y: auto;
  }
  .sidebar {
    order: -1;
    border-right: none;
    border-radius: 0px;
    border: 1px solid #d3d3d3;
    box-shadow: 5px 5px 10px #a9a9a9;
    margin-bottom: 18px;
  }
  
  
.settings-page li {
  margin-bottom: .1em;
}
.settings-page .settings-pane-left {
  width: 3em;  /* Adjust width to your preference */
}
.settings-page .settings-pane-right {
  margin-left: 3em;  /* Adjust width to match the width of settings-pane-left */
  max-height: 50vh;
  border: 2px solid blue;
}  
  
  .codeView-input,
  .functionDef-input,
  .system-input {
    resize: vertical;
    overflow: auto;
    width: 100%;
  }
  .conversation-zone {
    border-left: none;
  }
  .popup {
    width: 95%;
  }
}
@media (min-width: 769px) {
  .codeView-input,
  .functionDef-input,
  .system-input {
    height: 100%;
  }
}
</style>



<style>
.input-pair .btn,
.h2-container-controls .btn,
.setting-page .btn {
  padding: .5em 1em;
  cursor: pointer;
  background-color: #eeeeee;
  color: #121212;
  border: 1px solid #333;
  border-radius: 6px;
  transition: background-color 0.3s ease;
  min-height: 2em;
  align-items: center;
  white-space: nowrap;
}
.h2-container-controls .btn {
  margin-right: .5em;
}


/* Hamburger menu styles */
.btn,
.icon,
button {
  display: flex;
  cursor: pointer;
}
.btn:hover,
.icon:hover,
button:hover {
  background-color: #bbb;
}

.content {
  display: none;
}

.visible {
  display: flex;
}

.hidden {
  background-color: lightBlue;
  display: none;
}
</style>


</head>
<body>

  <div class="container">
    <header class="header">
      <!-- Left container for logo and GitHub link - always top line left hand corner -->
      <div class="h2-container-left">
        <span style="color: #212121;">prompt</span>
        <span style="color: red;">GenAI</span>
        <span id="github" style="color:#ccc;font-size:.5em">
          <a style="color: #212121;" href="https://github.com/aznight85048/promptgenai" target="_blank">github</a>@202406
        </span>
      </div>

      <span class="h2-container-gap"></span>

      <!-- Middle icons container for smaller screens and wrapped lines -->
      <div class="h2-container-icons-mid">
        <div class="icon hamburger" onclick="toggleVisibility('headerNav');">&#9776;</div>
        <div class="icon settings" onclick="toggleVisibility('sidebar-settings');">&#9881;</div>
<!--    <div class="icon settings" onclick="toggleVisibility('settingsPageContainer');">&#128196;</div> -->
      </div>

      <div class="header-nav hidden" id="headerNav">
        <button class="toggle-button" onclick="removeAllChildren('chat-container');usageStats.resetConversation();" title="Clear the Chat Conversation">Clear Chat</button>
        <button class="toggle-button" onclick="toggleVisibility('sidebar-codeView')" title="Toggle Code View sidebar">Code</button>
        <button class="toggle-button" onclick="toggleVisibility('sidebar-functionDef')" title="Toggle functionDef sidebar">functionDef</button>
        <button class="toggle-button" onclick="toggleVisibility('sidebar-roleSystem')" title="Toggle system sidebar">system</button>
        <button class="toggle-button" onclick="toggleVisibility('sidebar-apisView')" title="Toggle APIS sidebar">apis view</button>
<!--    <button class="toggle-button" onclick="toggleVisibility('sidebar-settings')" \
                title="Toggle Settings sidebar" id="settingsSideToggleBtn">Settings</button> -->
      </div>

      <span class="h2-container-gap"></span>

      <!-- Controls container -->
      <div class="h2-container-controls">
        <button class="btn" title="Copy model setting to hold area" onclick="copyToLocalStorage()">hold</button>
        <select class="parameter api-model" id="apiModel" required title="Select Model"></select>
      </div>

      <span class="h2-container-gap"></span>

      <!-- End icons container for larger screens and single lines -->
      <div class="h2-container-icons-end">
        <div class="icon hamburger" onclick="toggleVisibility('headerNav');">&#9776;</div>
        <div class="icon settings" onclick="toggleVisibility('sidebar-settings');">&#9881;</div>
<!--    <div class="icon settings" onclick="toggleVisibility('settingsPageContainer');">&#128196;</div>  -->
      </div>
    </header>


    <div class="page-content">

      <aside class="sidebar sidebar-left sidebar-codeView" title="Code View Sidebar">
        <div class="sidebar-header">
          <h3>Code</h3>
          <div class="sm-buttons-container">
            <button class="update-button" onclick="getCodeView('codeViewInput')" title="Refresh the Code View">refresh</button>
            <button class="clear-button" onclick="clearElementById('codeViewInput')" title="clear Code View">clear</button>
            <button id="optionsCodeToggleBtn" title="Toggle Code View Option Menu Bar" onclick="toggleVisibility('codeViewOptionsContainer');toggleButtonState(this)">options: OFF</button>
            <button class="help-button" onclick="openTablePopup('codeViewHelp')" title="Code View Help">?</button>
            <button class="close-button" onclick="toggleVisibility('sidebar-codeView', 'off')" title="Close Code View sidebar">x</button>
          </div>
        </div>
        <div class="toggle-buttons-container hidden" id="codeViewOptionsContainer">
          <button id="bodyCodeToggleBtn" title="Toggle Endpoint body View (JSON)" onclick="toggleButtonState(this)" data-enabled="false" class="button-enabled">body: OFF</button>
          <button id="responseCodeToggleBtn" title="Toggle Endpoint Last response View (JSON)" onclick="toggleButtonState(this)" data-enabled="false" class="button-enabled">response: OFF</button>
          <button id="statusCodeToggleBtn" title="Toggle Status View (text)" onclick="toggleButtonState(this)" data-enabled="false" class="button-enabled">status: OFF</button>
          <button id="usageCodeToggleBtn" title="Toggle Token Usage Summary (table)" onclick="toggleButtonState(this)" data-enabled="true" class="button-disabled">usage: ON</button>
        </div>
        <div class="sidebar-content">
          <textarea id="codeViewInput" class="codeView-input" placeholder="API Prompt JSON Will Be Displayed Here" title="Code View Display Only"></textarea>
        </div>
      </aside>

      <aside class="sidebar sidebar-left sidebar-functionDef" title="Function Definition Sidebar">
        <div class="sidebar-header">
          <h3>functionDef</h3>
          <div class="sm-buttons-container">
            <button class="clear-button" onclick="clearElementById('functionDefInput')" title="clear functionDef">clear</button>
            <button class="help-button" onclick="openTablePopup('functionDefHelp')" title="functionDef Help">?</button>
            <button class="close-button" onclick="toggleVisibility('sidebar-functionDef', 'off')" title="Close functionDef sidebar">x</button>
          </div>
        </div>
        <div class="sidebar-content">
          <textarea id="functionDefInput" class="functionDef-input" placeholder="Enter function definition JSON" title="Function Definition Input"></textarea>
        </div>
      </aside>

      <aside class="sidebar sidebar-left sidebar-roleSystem" title="System Sidebar">
        <div class="sidebar-header">
          <h3>System</h3>
          <div class="sm-buttons-container">
            <button class="clear-button" onclick="clearElementById('systemInput')" title="clear System Prompt">clear</button>
            <button class="close-button" onclick="toggleVisibility('sidebar-roleSystem', 'off')" title="Close System sidebar">x</button>
          </div>
        </div>
        <div class="sidebar-content">
          <textarea id="systemInput" class="system-input" placeholder="You are a helpful assistant." title="System Input"></textarea>
        </div>
      </aside>

      <aside class="sidebar sidebar-left sidebar-apisView" title="APIS Sidebar">
        <div class="sidebar-header">
          <h3>APIS Viewer</h3>
          <div class="sm-buttons-container">
            <button class="update-button" onclick="jsonDisplayById(apis || [], 'apisView')" title="Live APIS View">Live APIS</button>
            <button class="update-button" onclick="jsonDisplayById(JSON.parse(localStorage.getItem('apis')) ?? [], 'apisView')" title="Hold Config APIS View">Hold Config</button>
            <button class="update-button" onclick="if(window.imported_apis) { jsonDisplayById(window.imported_apis, 'apisView'); } else { jsonDisplayById([], 'apisView'); }" title="Imported APIS View">Imported APIS</button>
            <button class="clear-button" onclick="removeAllChildren('apisView')" title="clear apisView">clear</button>
            <button class="close-button" onclick="toggleVisibility('sidebar-apisView', 'off')" title="Close System sidebar">x</button>
          </div>
        </div>
        <div class="sidebar-content">
          <div class="json-container json-view">
            <div id="apisView" class="code"></div>
          </div>
        </div>
      </aside>

      <main class="conversation-zone" title="Main Conversation Zone">
        <div id="chat-container"></div>
        <div id="chat-interface">
          <button class="tts-button hidden" id="toggleSpeechBtn" onclick="toggleSpeech()" title="Click any message then click here to play">&#128264;</button>
          <textarea id="message-input" placeholder="Enter your message" rows="1" title="Message Input"></textarea>

          <div id="chatInputControl">

            <button class="mic-button hidden" id="chatMicBtn" onclick="toggleState('chatMicBtn', ['start'], ['stop', 'voiceToTextAddToPrompt']);" >mic</button>
            <div class="send-button-container" id="sendButtonContainer">
              <button class="send-button" id="sendButton" title="Send Button">Send</button>
              <div class="send-button-indicator" id="sendButtonIndicator"></div>
            </div>

          </div>

          <div class="chat-loading-container hidden" id="chatLoadingContainer">
            <div class="chat-loading" id="chatLoading" title="Chat Loading Indicator"></div>
          </div>
        </div>
      </main>


<aside class="sidebar sidebar-right sidebar-settings" title="Settings Sidebar">

  <div class="sidebar-header">
    <h3>SystemPage</h3>
    <div class="sm-buttons-container">
<!--  <button class="clear-button" onclick="clearElementById('systemInput')" title="clear System Prompt">clear</button> -->
      <button class="close-button" onclick="toggleVisibility('sidebar-settings', 'off')" title="Close SettingsPage sidebar">x</button>
    </div>
  </div>

  <div class="sidebar-content">

      <div class="settings-page" id="settingsPageContainer">
        <div class="settings-pane-left">
          <ul id="navList">
            <!-- Navigation items will be inserted here dynamically -->
          </ul>
        </div>

        <div class="settings-pane-right" id="settingsContent">

          <div class="section" id="apiSettings">
            <div class="section-header">
              <h3>API Settings</h3>
              <span class="icon">&#128295;</span>  <!-- &#9881 -->
            </div>
            <div class="apis-settings-container">
              <div class="input-pair local-storage-buttons">
                <button class="btn" title="Copy APIS settings to localStorage" onclick="copyToLocalStorage()">Hold API Settings</button>
                <button class="btn" title="Clear ALL settings in local storage" onclick="clearLocalStorage()">Clear Storage</button>
              </div>

              <div class="input-pair api-cards-container">

                <!-- api cards will be built and displayed here -->
              </div>

              <div class="input-pair">
                <button class="btn" id="apiParametersToggleBtn" title="API Parameters Toggle Button" onclick="toggleVisibility('apiParametersContainer')">API Parameters</button>
              </div>

              <div class="input-pair">
                <div class="api-parameters-container" id="apiParametersContainer"></div>

                <!-- selected API's parameters will dynamically built and displayed here -->
              </div>

              <div class="separator"></div>

            </div>
          </div>

          <div class="section" id="ttsSettings">

            <div class="section-header">
              <h3>Text to Speech</h3>
              <span class="icon">&#128264;</span>
            </div>

            <div class="input-pair">
<!--          <button class="btn" id="ttsToggleBtn" title="Toggle Text to Speech Functionality and Controls" onclick="toggleVisibility('toggleSpeechBtn');toggleVisibility('msg-icon-audio');toggleButtonState(this)">Text to Speech: OFF</button> -->
              <button class="btn" id="ttsToggleBtn" title="Toggle Text to Speech Functionality and Controls" onclick="toggleVisibility('toggleSpeechBtn');toggleButtonState(this)">Text to Speech: OFF</button>
            </div>

            <div class="tts-settings-container" id="ttsSettingsContainer">
              <div class="input-pair slider-container">
                <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1">
                <input type="text" id="volume">
                <label for="volume">Volume</label>
              </div>
              <div class="input-pair slider-container">
                <input type="range" id="rate-slider" min="0.1" max="10" step="0.1" value="1">
                <input type="text" id="rate">
                <label for="rate">Rate</label>
              </div>
              <div class="input-pair slider-container">
                <input type="range" id="pitch-slider" min="0" max="2" step="0.1" value="1">
                <input type="text" id="pitch">
                <label for="pitch">Pitch</label>
              </div>
              <div class="input-pair">
                <button class="btn" title="Copy TTS settings to localStorage" onclick="copyToLocalStorage('.tts')">Hold TTS Settings</button>
              </div>
            </div>
            <div class="separator"></div>
          </div>

          <div class="section" id="vttSettings">
            <div class="section-header">
              <h3>Voice to Text</h3>
              <span class="icon">&#127908;</span>
            </div>
            <div class="input-pair">
              <button id="vttToggleBtn" class="btn" title="Voice to Text Functionality and Controls" onclick="toggleVisibility('chatMicBtn');clickElementById('stop');toggleButtonState(this)">Voice to Text: OFF</button>
            </div>

            <div class="vtt-settings-container" id="vttSettingsContainer">
            	
              <div class="voiceToText-container">
                <textarea id="transcripts" placeholder="Click [start] to begin recording"></textarea>
              </div>
              
              <div class="input-pair">
                <button class="btn" id="start">Start&nbsp;&nbsp;<span>&#9654;</span></button>
                <button class="btn" id="stop">Stop&nbsp;&nbsp;<span>&#9209;</span></button>
                <button class="btn" id="voiceToTextAddToPrompt" onclick="transcriptAdd('message-input')">Add to Prompt</button>
                <button class="btn" id="voiceToTextReplacePrompt" onclick="transcriptReplace('message-input')">Replace Prompt</button>
                <button class="hidden" id="voiceToTextAddButton" onclick="transcriptAdd(lastSelectedTextarea)">Add to Selected</button>
              </div>
              
              <div class="voiceToText-container">
                <textarea id="voiceToTextLog" placeholder="Voice-to-text System Messages"></textarea>
              </div>
              
              <div class="vtt-container-sub">
                <div class="input-pair row">
                  <label for="continuous">Continuous:</label>
                  <input class="cbx" type="checkbox" id="continuous" checked>
                </div>
                <div class="input-pair row">
                  <label for="interim">Interim:</label>
                  <input class="cbx" type="checkbox" id="interim" checked>
                </div>
                <div class="input-pair row">
                  <label for="max">MaxAlt:</label>
                  <input type="number" id="maxAlt" value="1">
                </div>
                <div class="input-pair row">
                  <label for="lang">Language:</label>
                  <select id="lang">
                    <option value="en-US">English (US)</option>
                    <option value="en-GB">English (UK)</option>
                    <option value="fr-FR">French</option>
                    <option value="es-ES">Spanish</option>
                    <option value="de-DE">German</option>
                  </select>
                </div>
                <div class="input-pair">
                  <button class="btn" id="reset">Apply</button>
                  <button class="btn" title="Copy VTT settings to localStorage" onclick="copyToLocalStorage('.vtt')">Hold VTT Settings</button>
                </div>
              </div>
            </div>
            <div class="separator"></div>
          </div>

          <div class="section" id="userInterface">
            <div class="section-header">
              <h3>User Interface</h3>
              <span class="icon">&#128100;</span>
            </div>
            <div class="input-pair">
              <button id="enterToSendBtn" class="btn button-enabled" data-enabled="true" title="Toggle Use of [Enter] Key to Send" onclick="toggleButtonState(this)">Enter to Send: ON</button>
            </div>
            <div class="input-pair">
              <button id="sendButtonToggleBtn" class="btn" title="Toggle Send Button View" onclick="toggleVisibility('sendButton');toggleVisibility('chatInputControl');toggleButtonState(this)">Send Button: ON</button>
            </div>
            <div class="input-pair">
              <button id="statusBarToggleBtn" class="btn" title="Toggle Status Bar View" onclick="toggleVisibility('statusBarText');toggleButtonState(this)">Status Bar: OFF</button>
            </div>
            <div class="separator"></div>
          </div>

          <div class="section" id="helpSection">
            <div class="section-header">
              <h3>Help</h3>
              <span class="icon">&#10067;</span>
            </div>
            <div class="input-pair">
              <button class="btn" onclick="openTablePopup('ollamaHelp')" title="Ollama Help">Ollama.local Help</button>
            </div>
            <div class="separator"></div>
          </div>

          <div class="section" id="comonIssues">
            <div class="section-header">
              <h3>Common Issues</h3>
              <span class="icon">&#9888;</span>
            </div>
            <div class="input-pair">
              <button class="btn" onclick="toggleButtonState(this);" title="Common Issues Window Toggle">Issues Window: OFF</button>
            </div>
            <div class="separator"></div>
          </div>

          
          <div class="section" id="hintsSection">
            <div class="section-header">
              <h3>Hint Window</h3>
              <span class="icon">&#128161;</span>
            </div>
            <div class="input-pair">
              <button class="btn" onclick="toggleButtonState(this);" title="Hint Window Toggle">Hint Window: OFF</button>
            </div>
            <div class="separator"></div>
          </div>
          
          <div class="end-of-scroll-page-gap"></div>
        </div>
      </div>
<!--</div> -->
  </div>
</aside>

    </div>
    <footer class="footer">

      <div class="status-bar-text hidden" id="statusBarText"></div>
    </footer>

<!--
    <div class="overlay"></div>
    <div class="popup">
      <div class="popup-header" id="popupHeader"></div>
      <div class="popup-table" id="popupTable"></div>
    </div>
  </div>
-->

<script>
    function testCors(endpoint, timeout) {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          reject('Timeout occurred');
        }, timeout);

        fetch(endpoint, {
          method: 'GET',
          mode: 'cors'
        })
        .then(response => {
          resolve(response.status);
        })
        .catch(error => {
          resolve(error);
        });
      });
    }
</script>

<script>
    let altapis = [];

    function loadAltAPIs() {
      return new Promise((resolve, reject) => {
        altapis = [
          {
            label: "openai.api",
            models: [
              { "model": "gpt-3.5-turbo" },
              { "model": "gpt-3.5-turbo-0125" },
              { "model": "gpt-4o" },
              { "model": "gpt-4o-2024-05-13" },
              { "model": "gpt-4-turbo-2024-04-09" },
              { "model": "gpt-4-0125-preview" },
              { "model": "gpt-4-1106-preview" },
              { "model": "gpt-3.5-turbo-1106" },
              { "model": "gpt-4" },
              { "model": "gpt-4-0613" }
            ]
          }
        ];
        resolve(altapis);
      });
    }
</script>

<script>
    let parameters_apis = [];

    function loadParameters_apis() {
      return new Promise((resolve, reject) => {
        const parameters_apis = [
          {
            label: "openai.api",
            parameters: {
              key: "YOUR_OPEN_AI_API_KEY_GOES_HERE",
              model: "gpt-3.5-turbo-0125",
              temperature: "0.7",
              max_tokens: "",
              top_p: "",
              frequency_penalty: "",
              presence_penalty: ""
            }
          },
          {
            label: "ollama.local",
            parameters: {
              key: "ollama",
              model: "phi3:3.8b-mini-instruct-4k-q4_K_M",
              temperature: "0",
              max_tokens: "",
              top_p: "",
              frequency_penalty: "",
              presence_penalty: ""
            }
          },
          {
            label: "ollama.lab",
            parameters: {
              key: "ollama",
              model: "tinydolphin:1.1b-v2.8-q5_K_M",
              temperature: "0",
              max_tokens: "",
              top_p: "",
              frequency_penalty: "",
              presence_penalty: ""
            }
          }
        ];
        resolve(parameters_apis);
      });
    }
</script>

<script>
    let apis = [];

    function loadAPIs() {
      return new Promise((resolve, reject) => {
        apis = [
          {
            label: "openai.api",
            status: "",
            endpoint: {
              base: "https://api.openai.com",
              check: {
                url: "https://status.openai.com/api/v2/status.json",
                status: 0
              },
              chat: "https://api.openai.com/v1/chat/completions",
              headers: { "Content-Type": "application/json", "Authorization": "Bearer ${endpointKey}" },
              models: "",
              parameters: ""
            }
          },
          {
            label: "ollama.local",
            status: "",
            endpoint: {
              headers: { "Content-Type": "application/json" },
              base: "http://127.0.0.1:11434",
              check: {
                url: "http://127.0.0.1:11434",
                status: 0
              },
              chat: "http://127.0.0.1:11434/v1/chat/completions",
              models: "http://127.0.0.1:11434/api/tags",
              parameters: ""
            }
          },
          {
            label: "ollama.lab",
            status: "",
            endpoint: {
              headers: { "Content-Type": "application/json" },
              base: "http://192.168.1.51:11434",
              check: {
                url: "http://192.168.1.51:11434",
                status: 0
              },
              chat: "http://192.168.1.51:11434/v1/chat/completions",
              models: "http://192.168.1.51:11434/api/tags",
              modelShow: "http://192.168.1.51:11434/api/show",
              parameters: ""
            }
          }
        ];
        resolve(apis);
      });
    }
</script>

<!--
              modelshow: "http://192.168.1.51:11434/api/show?name=${model}",
              modelshow: "http://192.168.1.51:11434/api/show?name=tinydolphin:1.1b-v2.8-q5_K_M",
-->

<script>
    function fetchApiEndpointModels(api) {
      let models = [];
      return fetch(api.endpoint.models, {
        method: 'GET',
        headers: api.endpoint.headers
      })
      .then(response => response.json())
      .then(data => {
      //const models = data.models;  // -t20240516T1328 -
        models = data.models || [];  // +t20240516T1328 - Ensure `models` is an array even if `data.models` is not defined.
        return models;
      })
      .catch(error => {
        console.error("Failed to fetch models:", api.label, error);
        throw error;
      });
    }
</script>

<script>
    function updateApiCardStatus(api) {
        const apiContainer = document.querySelector(".api-cards-container");
        const apiCard = document.createElement("div");
        apiCard.classList.add("api-card", api.status);
        apiCard.textContent = `${api.label}`;
        apiCard.title = `${api.label} - ${api.status}`;
        apiCard.id = 'card-' + api.label;
        let onclickAction = "selectElementIdFromClass(this.id, 'api-card'); selectApiByLabel(this.id.replace('card-', ''));";
        apiCard.setAttribute("onclick", onclickAction);
        apiContainer.appendChild(apiCard);
    }

    function apisEndpointCheckStatusSet(apis) {
      return Promise.all(apis.map(api => {
        return testCors(api.endpoint.check.url, 2000)
          .then(status => {
          //api.endpoint.check.status = typeof status !== 'number' ? -1 : status; //  -t20240516T1328
            api.endpoint.check.status = typeof status === 'number' ? status : -1;  //  +t20240516T1328
          }).catch(error => {
            console.error('Failed to check status for:', api.label, error);
            api.endpoint.check.status = -1;
          });
      }));
    }
</script>

<script>
function apisStatusSet(apis) {
    return Promise.all(apis.map(api => {
      return new Promise((resolve) => {
        let apiParameters = parameters_apis.find(apiParameters => apiParameters.label === api.label);
        if (apiParameters && !api.parameters) {
          api.parameters = apiParameters.parameters;
        }

        let useMe = { api: [], label: "", source: "" };

        if (useMe.label === "") {
          let localStorage_apis = JSON.parse(localStorage.getItem('apis')) || [];
          try {
            if (localStorage_apis.length) {
              let localStorage_api = localStorage_apis.find(item => item.label === api.label);
              if (localStorage_api) {
                useMe = localStorage_api;
                useMe.label = api.label;
                useMe.source = "localStorage_api";
              }
            }
          } catch (error) {
            console.error('Error while checking localStorage_apis:', error);
          }
        }

        if (useMe.label === "") {
          try {
            if (typeof imported_apis !== 'undefined') {
              if (imported_apis && imported_apis.length > 0) {
                let imported_api = imported_apis.find(item => item.label === api.label);
                if (imported_api) {
                  useMe = imported_api;
                  useMe.label = api.label;
                  useMe.source = "imported_api";
                }
              }
            }
          } catch (error) {
            console.error('Error while checking imported_apis:', error);
          }
        }

        if (useMe.label === "") {
          try {
            if (parameters_apis.length) {
              let parameters_api = parameters_apis.find(item => item.label === api.label);
              if (parameters_api) {
                useMe.parameters = parameters_api.parameters;
                useMe.label = api.label;
                useMe.source = "parameters_api";
              }
            }
          } catch (error) {
            console.error('Error while checking parameters_apis:', error);
          }
        }

        if (useMe.label !== "") {
          api.parameters = useMe.parameters;
        }

        if (api.endpoint.check.status === 200) {
          api.status = "ready";

          if (api.endpoint.models) {
            fetchApiEndpointModels(api).then(models => {
              api.models = models;
              addModelsToModelSelector(api);
              updateApiCardStatus(api);
              if (!firstReadyApiLabel) {
                firstReadyApiLabel = api.label;
              }
              resolve();
            });
          } else {
            let altapi = altapis.find(altapi => altapi.label === api.label);
            if (altapi) {
              api.models = altapi.models;
              addModelsToModelSelector(api);
              updateApiCardStatus(api);
              if (!firstReadyApiLabel) {
                firstReadyApiLabel = api.label;
              }
            }
            resolve();
          }
        } else {
          api.status = "na";
          updateApiCardStatus(api);
          resolve();
        }
      });
    })).then(() => {
      if (firstReadyApiLabel) {
        // document.getElementById('card-' + firstReadyApiLabel).click();
      }
    });
}
</script>

<script>
    let importFileName = '';
    let importFunctionName = '';
    let selectedAPI = [];
    let firstReadyApiLabel = '';
    let statusLineList = '';
    let endpointKey  = '';  // +t20240516T1913

    const selector = document.getElementById('apiModel');
    selector.innerHTML = '';

    loadAltAPIs()
      .then((loadedAltApis) => {
        altapis = loadedAltApis;
        return loadAPIs();
      })
      .then((loadedApis) => {
        apis = loadedApis;
        return loadParameters_apis();
      })
      .then((parameters) => {
        parameters_apis = parameters;
        return apisEndpointCheckStatusSet(apis);
      })
      .then(() => {
        return apisStatusSet(apis);
      })
      .then(() => {
        if (firstReadyApiLabel) {
          let selectedAPI = apis.find(api => api.label === firstReadyApiLabel);
          console.log('set selectedAPI:', selectedAPI);
          document.getElementById('card-' + firstReadyApiLabel).click();
        }
        apiModel.dispatchEvent(new Event('change'));
      })
      .catch((error) => {
        console.error('An error occurred:', error);
      });
</script>

<script src="zYekKit-20231227T1329.js" defer></script>
<script src="importData-apis.js" defer></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      populateFromLocalStorage();
      apisFromLocalStorage();

    console.log('ck1 screen toggle selectedAPI::', selectedAPI);
    setTimeout(function() {
      while(selectedAPI.label === '') {
        setTimeout(() => {console.log("Waited 0.1 seconds")}, 100);
      }
      console.log('ch2 screen toggle selectedAPI::', selectedAPI);

      if (!selectedAPI || !selectedAPI.parameters || !selectedAPI.parameters.key || !selectedAPI.parameters.key.trim()) {
        toggleVisibility('sidebar-settings', 'on');
//      clickElementById('apiParametersToggleBtn');
      } else {
        toggleVisibility('sidebar-settings', 'off');
      }
      if (document.getElementById('codeViewInput').value === ''){
        toggleVisibility('sidebar-codeView', 'off');
      } else {
        toggleVisibility('sidebar-codeView', 'on');
      }
      if (document.getElementById('functionDefInput').value === ''){
        toggleVisibility('sidebar-functionDef', 'off');
      } else {
        toggleVisibility('sidebar-functionDef', 'on');
      }
      if (document.getElementById('systemInput').value === ''){
        toggleVisibility('sidebar-roleSystem', 'off');
      } else {
        toggleVisibility('sidebar-roleSystem', 'on');
      }
      if (document.getElementById('apisView').innerHTML === ''){
        toggleVisibility('sidebar-apisView', 'off');
      } else {
        toggleVisibility('sidebar-apisView', 'on');
      }

      endpointKey = (typeof yekKit !== 'undefined' && yekKit) ? yekKit : (selectedAPI && selectedAPI.parameters && selectedAPI.parameters.key ? selectedAPI.parameters.key : '');
      chatReadyCheck('sendButtonIndicator', endpointKey);
    }, 1000);

      initializeRangeInputs();
    });

  const chatContainer = document.getElementById('chat-container');
  const messageInput = document.getElementById('message-input');
  const sendButton = document.getElementById('sendButton');
  const enterToSendToggle = document.getElementById('enterToSendBtn');

  let ollamaStatus = 'none';
  let statusLine = '';
  let bodyJson = '';
  let lastResponse = {};

//sendButton.addEventListener('click', () => {    // -t20240516T1328 - If calling async functions listener, it should be async itself.
  sendButton.addEventListener('click', async () => {
    const message = messageInput.value.trim();
    if (message != '') {
      appendMessage(message, 'user');
      messageInput.value = '';
      chatSendMessage();
    } else {
      messageInput.value = '';
    }
  });


  messageInput.addEventListener('keydown', (event) => {
    const enterToSendEnabled = enterToSendToggle.getAttribute('data-enabled') === 'true';
    if (enterToSendEnabled && event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      const message = messageInput.value.trim();
      if (message != '') {
        sendButton.click();
      }
    }
  });


  function toggleNav() {
    var nav = document.querySelector('.header nav');
    nav.style.display = (nav.style.display === 'flex') ? 'none' : 'flex';
  }


  function toggleButtonState(buttonElement, labelElementId = null) {
    const labelElement = labelElementId ? document.getElementById(labelElementId) : buttonElement;

    // Check the initial state based on the text content
    const currentStateText = labelElement.textContent.trim();
    const isEnabled = currentStateText.endsWith(': ON');

    // Determine the new state
    const newState = !isEnabled;

    // Update the 'data-enabled' attribute
    buttonElement.setAttribute('data-enabled', newState.toString());

    // Update the text content of the label
    const labelBase = currentStateText.replace(': ON', '').replace(': OFF', '').trim();
    labelElement.textContent = `${labelBase}: ${newState ? 'ON' : 'OFF'}`;

    // Update the CSS classes
    labelElement.classList.toggle('button-enabled', newState);
    labelElement.classList.toggle('button-disabled', !newState);
  }

/*
  function toggleButtonState(buttonElement, labelElementId = null) {
    const labelElement = labelElementId ? document.getElementById(labelElementId) : buttonElement;
    const isEnabled = buttonElement.getAttribute('data-enabled') === 'true';
    const newState = !isEnabled;
    buttonElement.setAttribute('data-enabled', newState.toString());
    const labelBase = labelElement.textContent.replace(': ON', '').replace(': OFF', '').trim();
    labelElement.textContent = `${labelBase}: ${newState ? 'ON' : 'OFF'}`;
    labelElement.classList.toggle('button-enabled', newState);
    labelElement.classList.toggle('button-disabled', !newState);
  }
*/

  function clearElementById(elementId) {
    const element = document.getElementById(elementId);
    element.value = "";
    element.innerHTML = "";
  }

  function removeAllChildren(elementId) {
    var chatContainer = document.getElementById(elementId);
    while (chatContainer.firstChild) {
      chatContainer.removeChild(chatContainer.firstChild);
    }
  }

  function clearLocalStorage(selector) {
    if (selector) {
      let elements = document.querySelectorAll(selector);
      elements.forEach(element => {
        localStorage.removeItem(element.id);
      });
    } else {
      localStorage.clear();
    }
  }

  function copyToLocalStorage(selector) {
    if (selector) {
      let elements = document.querySelectorAll(selector);
      elements.forEach(element => {
        if (element.tagName.toLowerCase() === 'input' || element.tagName.toLowerCase() === 'textarea') {
          localStorage.setItem(element.id, element.value);
        } else if (element.tagName.toLowerCase() === 'select') {
          localStorage.setItem(element.id, element.options[element.selectedIndex].value);
        } else {
          localStorage.setItem(element.id, element.innerHTML);
        }
      });
    } else {
      apisToLocalStorage();
    }
  }

  function apisToLocalStorage() {
    apiModel.dispatchEvent(new Event('change'));
    const apisJson = JSON.stringify(apis, null, 2);
    localStorage.setItem('apis', apisJson);
  }

  function apisFromLocalStorage() {
    const apisJson = localStorage.getItem('apis');
    if (apisJson) {
        apis = JSON.parse(apisJson);
    }
    apiModel.dispatchEvent(new Event('change'));
  }

  function populateFromLocalStorage() {
    for (let i = 0; i < localStorage.length; i++) {
      let key = localStorage.key(i);
      let element = document.getElementById(key);
      if (element) {
        if (element.tagName.toLowerCase() === 'input' || element.tagName.toLowerCase() === 'textarea') {
          element.value = localStorage.getItem(key);
        } else if (element.tagName.toLowerCase() === 'select') {
          let value = localStorage.getItem(key);
          for (let option of element.options) {
            if (option.value === value) {
              option.selected = true;
              break;
            }
          }
        } else {
          element.innerHTML = localStorage.getItem(key);
        }
      }
    }
    apiModel.dispatchEvent(new Event('change'));
  }

  function toggleVisibility(target, status) {
    //console.log('toggleVisibility():', target, status);
    const elements = document.getElementById(target) ? [document.getElementById(target)] : document.querySelectorAll('.' + target);
    if (!elements.length) {
      return;
    }
    elements.forEach(element => {
      switch(status) {
        case 'on':
          element.classList.add('visible');
          element.classList.remove('hidden');
          break;
        case 'off':
          element.classList.add('hidden');
          element.classList.remove('visible');
          break;
        default:
          if (element.classList.contains('hidden')) {
            element.classList.remove('hidden');
            element.classList.add('visible');
          } else {
            element.classList.remove('visible');
            element.classList.add('hidden');
          }
          break;
      }
    });
  }

  function scrollToBottom(target) {
    console.log('scrollToBottom():', target);
    const container = document.querySelector(target);
    console.log('...container:', container);
    const parentContainer = container.parentElement;
    console.log('...parentContainer:', parentContainer);
    setTimeout(() => {
      container.scrollTop = container.scrollHeight;
      if (parentContainer.scrollHeight > parentContainer.clientHeight) {
        parentContainer.scrollTop = parentContainer.scrollHeight;
      }
    }, 0);
  }

  function showChatLoading() {
    document.getElementById('chatLoadingContainer').classList.remove('hidden');
    document.getElementById('sendButtonContainer').classList.add('hidden');
  }

  function hideChatLoading() {
    document.getElementById('chatLoadingContainer').classList.add('hidden');
    document.getElementById('sendButtonContainer').classList.remove('hidden');
  }

  function appendMessage(content, className) {
    const messageDiv = createChatMessageElement(content, className);
    messageDiv.classList.add('message', className);
    chatContainer.prepend(messageDiv);
    scrollToBottom('#chat-container');
  }

  async function buildFunctions() {
    const functions = [];
    let content = document.getElementById('functionDefInput').value;
    try {
      let parsedContent = JSON.parse(content);
      functions.push(parsedContent);
    } catch (error) {
    }
    return functions;
  }

async function buildMessages() {
    let messages = [];
    let content = document.getElementById('systemInput').value;
    let role = 'system';

    if (content !== "") {
      messages.push({ role, content });
    }

    let section = document.getElementById('chat-container');
    if (!section) {
      console.error('chat-container element not found');
      return messages;
    }

    let messageElements = section.querySelectorAll('.message-element');
    messageElements.forEach((element) => {
      role = element.querySelector('.role-indicator').textContent;
      content = element.querySelector('.content.raw').textContent;
      messages.unshift({ role, content });
    });

    return messages;
}

async function newConversation() {
    let startTime, endTime;
    let functions = [];
    let messages = [];
    let body = {};
    let model = selectedAPI.parameters.model;

    let temperature = parseFloat(selectedAPI.parameters.temperature);
    let max_tokens = parseInt(selectedAPI.parameters.max_tokens);
    let top_p = parseFloat(selectedAPI.parameters.top_p);
    let frequency_penalty = parseFloat(selectedAPI.parameters.frequency_penalty);
    let presence_penalty = parseFloat(selectedAPI.parameters.presence_penalty);

    if (model && model !== "") { body = { ...body, model }; }
    if (temperature && temperature > 0) { body = { ...body, temperature }; }
    if (max_tokens && max_tokens > 0) { body = { ...body, max_tokens }; }
    if (top_p && top_p > 0) { body = { ...body, top_p }; }
    if (frequency_penalty && frequency_penalty > 0) { body = { ...body, frequency_penalty }; }
    if (presence_penalty && presence_penalty > 0) { body = { ...body, presence_penalty }; }

    functions = await buildFunctions();
    messages = await buildMessages();

    if (functions && functions.length > 0) {
        body = { ...body, function_call: "auto" };
    }
    if (messages.length > -1) {
        body = { ...body, messages };
    }
    if (functions.length > 0) {
        body = { ...body, functions };
    }

    return body;
}

function chatReadyCheck(elementId, ...variables) {
    const element = document.getElementById(elementId);
    let isReady = variables.some(variable => typeof variable !== 'undefined' && variable !== 'notDefined' && variable !== '');
    element.classList.toggle('ready', isReady);
}

async function chatSendMessage() {
    let endpointURL = selectedAPI.endpoint.chat;
    let headers = selectedAPI.endpoint.headers;
    let data;
    let message = {};
    let content = '';
    let role = '';
    let passCount = 0;

    bodyJson = await newConversation();
    let endpointKey = (typeof yekKit !== 'undefined' && yekKit) ? yekKit : (selectedAPI.parameters.key || '');
    chatReadyCheck('sendButtonIndicator', endpointKey);
    usageStats.resetChat();

    while (true) {
        showChatLoading();
        passCount += 1;
        if (passCount > 4) {
            throw new Error('Too many function calls');
        }

        startTime = Date.now();

        if (endpointURL.startsWith("https:")) {
            headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${endpointKey}` };
        }

        const response = await fetch(endpointURL, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(bodyJson)
        });

        data = await response.json();
        endTime = Date.now();
        lastResponse = data;

        if (data.error) {
            console.error('API Error:', data.error.message);
            alert(`API Error: ${data.error.message}`);
            toggleVisibility('sidebar-settings', 'on');
            break;
        } else {
            statusLine = createStatusLine(data);
            document.getElementById('statusBarText').innerText = statusLine;
            usageStats.updateUsage(data);
        }

        role = data.choices[0].message.role;
        content = data.choices[0].message.content || "";
        bodyJson.messages.push({ role, content });

        if (data.choices[0].finish_reason == 'function_call') {
            message = data.choices[0].message;
            message = replaceNullWithEmptyString(message);
            bodyJson.messages.push(message);

            let functionName = data.choices[0].message.function_call.name;
            let functionArgs = Object.values(JSON.parse(data.choices[0].message.function_call.arguments));

          //let functionResponse = await apiCallFunction(functionName, ...functionArgs); //  -t20240516T1328
            let functionResponse = await apiCallFunction(functionName, ...functionArgs) || '{"status": "success", "message": "The operation completed successfully, no errors were reported."}'; //  +t20240516T1328
            functionResponse = JSON.stringify(JSON.parse(functionResponse).content);
            bodyJson.messages.push({ role: 'function', name: functionName, content: functionResponse });
        } else {
            break;
        }
    }

    hideChatLoading();

    if (!data.error) {
        const botReply = data.choices[0].message.content;
        appendMessage(botReply, 'assistant');
    }
}


function createChatMessageElement(message, source) {
    const date = new Date();
    const msgId = "msgId" + date.toISOString().replace(/[:\-Z]/g, '').replace(/\./g, '_');
    const formats = [];
    const messageElement = document.createElement('div');
    messageElement.classList.add('message-element');
    messageElement.id = msgId;

    // Create and append header
    const headerElement = createHeaderElement(source);
    messageElement.appendChild(headerElement);

    // Parse and format content
    const contentFormats = parseAndFormatContent(message);
    contentFormats.forEach(format => {
        messageElement.appendChild(format.element);
        formats.push(format.type);
    });

    // Populate message type selector
    const messageTypeSelector = headerElement.querySelector('.message-type-selector');
    populateMessageTypeSelector(messageTypeSelector, formats);
    setupMessageTypeSelectorHandler(messageTypeSelector, messageElement);

    // Show the first format by default
    if (formats.length > 1) {
        messageTypeSelector.classList.add('visible');
        messageTypeSelector.selectedIndex = 1;
    } else {
        contentFormats[0].element.classList.add('visible');
    }

    messageTypeSelector.selectedIndex = 0;
    messageTypeSelector.dispatchEvent(new Event('change'));
    return messageElement;
}

function createHeaderElement(source) {
    const headerElement = document.createElement('div');
    headerElement.classList.add('chat-message-header');

    const roleIndicator = document.createElement('span');
    roleIndicator.classList.add('role-indicator');
    roleIndicator.textContent = source;
    headerElement.appendChild(roleIndicator);

    const altIndicator = document.createElement('span');
    altIndicator.classList.add('alt-indicator');
    altIndicator.textContent = selectedAPI.parameters.model || 'no model selected';
    headerElement.appendChild(altIndicator);

    const msgHeadGap = document.createElement('span');
    altIndicator.classList.add('head-gap');
    headerElement.appendChild(msgHeadGap);


    const chatAudioControls = document.createElement('span');
    chatAudioControls.classList.add('container', 'msg-controls');

      const readTextButton = document.createElement('button');
      readTextButton.classList.add('msg-icon-audio', 'hidden');
      readTextButton.innerHTML = "<span>&#9654</span>";
      readTextButton.title = "Play Text-to-Speech";
      readTextButton.onclick = () => readText();
    chatAudioControls.appendChild(readTextButton);

      const stopReadButton = document.createElement('button');
      stopReadButton.classList.add('msg-icon-audio', 'hidden');
      stopReadButton.innerHTML = "<span>&#9632</span>";
      stopReadButton.title = "Stop Text-to-Speech";
      stopReadButton.onclick = () => stopSpeech();
    chatAudioControls.appendChild(stopReadButton);

//    const chatMicButton = document.createElement('button');
//    chatMicButton.classList.add('msg-icon-audio');
//    chatMicButton.innerHTML = "<span>&#127908</span>";
//    chatMicButton.onclick = () => toggleElementById('chatMicBtn');
//  chatAudioControls.appendChild(chatMicButton);

    headerElement.appendChild(chatAudioControls);

    const chatNavControls = document.createElement('span');
    chatNavControls.classList.add('container', 'msg-controls-nav');

      const messageTypeSelector = document.createElement('select');
      messageTypeSelector.classList.add('message-type-selector');
      messageTypeSelector.title = 'select message type';
    chatNavControls.appendChild(messageTypeSelector);


      const messageCopyButton = document.createElement('button');
      messageCopyButton.classList.add('msg-icon-copy');
      messageCopyButton.innerHTML = "<span>&#x2398;</span>";  // Unicode for copy icon
      messageCopyButton.title = "Copy to Clipboard";
      messageCopyButton.addEventListener('click', (event) => {
        // Find the closest parent message element
        const messageElement = event.target.closest('.message-element');
        if (messageElement) {
          // Find the content within this specific message element
          const content = messageElement.querySelector('.content.raw')?.textContent;
          if (content) {
            navigator.clipboard.writeText(content)
              .then(() => alert('Code copied to clipboard!'))
              .catch(err => console.error('Failed to copy text: ', err));
          } else {
            console.error('No content found to copy.');
          }
        } else {
          console.error('No message element found.');
        }
      });
    chatNavControls.appendChild(messageCopyButton);


//    const messageBranchButton = document.createElement('button');
//    messageBranchButton.classList.add('msg-icon-nav');
//    messageBranchButton.textContent = 'b';  // future branch function - (create editable sibling)
//    messageBranchButton..innerHTML = "<span>&#9747</span>";  // zzz 20240531T1549 needs the branch icon unicode
//    messageBranchButton.title = 'Branch Conversation';
//    messageBranchButton.addEventListener('click', () => {
//      navigator.clipboard.writeText(block.content)  // zzz 20240531T1549 this needs to copy content RAW
//        .then(() => alert('Code copied to clipboard!'))
//        .catch(err => console.error('Failed to copy text: ', err));
//    });
//  chatNavControls.appendChild(messageBranchButton);

//    const minButton = document.createElement('button');
//    minButton.classList.add('msg-icon-nav', 'minimize-message-button');
//    minButton.innerHTML = "<span>&#9473</span>";
//    minButton.onclick = () => headerElement.parentElement.remove();
//  chatNavControls.appendChild(minButton);

//    const maxButton = document.createElement('button');
//    maxButton.classList.add('msg-icon-nav', 'maximize-message-button');
//    maxButton.innerHTML = "<span>&#9633</span>";
//    maxButton.onclick = () => headerElement.parentElement.remove();
//  chatNavControls.appendChild(maxButton);

      const removeButton = document.createElement('button');
      removeButton.classList.add('msg-icon-nav', 'remove-message-button');
      removeButton.innerHTML = "<span>&#9747</span>";
      removeButton.title = 'remove this message';
      removeButton.onclick = () => headerElement.parentElement.remove();
    chatNavControls.appendChild(removeButton);

    headerElement.appendChild(chatNavControls);

    return headerElement;
}
</script>


<script>
  function parseAndFormatContent(message) {
    const formats = [];

    // Add code formatted container if applicable
    if (message.startsWith('```') && message.endsWith('```')) {
      const codeContent = message.slice(3, -3).trim();
      const codeFormattedContainer = createContentElement('pre', 'code', codeContent);
      formats.push({ element: codeFormattedContainer, type: 'code' });
    } else if (message.includes('```')) {
      const parsedData = extractAndRenderContentBlocks(message);
      let xcodeFormattedContainer = document.createElement('div');
      xcodeFormattedContainer = parsedData;
      xcodeFormattedContainer.classList.add('content', 'xcode');
      console.log('xcodeFormattedContainer:', xcodeFormattedContainer);
      formats.push({ element: xcodeFormattedContainer, type: 'xcode' });
    } else {
      console.log('NO code blocks found:');
    };

    // Add JSON format if applicable
    try {
      const parsedMessage = JSON.parse(message);
      const jsonFormattedContainer = createContentElement('pre', 'json', JSON.stringify(parsedMessage, null, 2));
      formats.push({ element: jsonFormattedContainer, type: 'json' });
    } catch (error) {
      // Not JSON
    }

    // Add multiline text format if applicable
    if (message.includes('\n')) {
      const textFormattedContainer = createContentElement('pre', 'textn', message);
      formats.push({ element: textFormattedContainer, type: 'textn' });
    }

   // Add HTML/markup format if applicable
    if (message.startsWith('<') && message.endsWith('>')) {
      const htmlTextViewContainer = createContentElement('pre', 'htmltxt', message);  // isHTML should be false
      formats.push({ element: htmlTextViewContainer, type: 'htmltxt' });

      const htmlRenderedViewContainer = createContentElement('div', 'htmlrnd', message, true);  // isHTML should be true
      formats.push({ element: htmlRenderedViewContainer, type: 'htmlrnd' });
    } else if (message.startsWith('# ')) {
      const markupFormattedContainer = createContentElement('div', 'markup', message, true);  // isHTML should be true
      formats.push({ element: markupFormattedContainer, type: 'markup' });
    }

    // Add raw format
    const rawContentContainer = createContentElement('pre', 'raw', message);
    formats.push({ element: rawContentContainer, type: 'raw' });

    // Add plain text format
    const textContentContainer = createContentElement('div', 'text', message);
    formats.push({ element: textContentContainer, type: 'text' });

/*
    // Add HTML format if message contains ```html
    if (message.includes('```html')) {
      const htmlCodeBlock = message.match(/```html([\s\S]*?)```/);
      if (htmlCodeBlock) {
        const htmlContent = htmlCodeBlock[1].trim();
        const htmlTextViewContainer = createContentElement('pre', 'html-text', htmlContent);
        formats.push({ element: htmlTextViewContainer, type: 'html-text' });

        const htmlRenderedViewContainer = createContentElement('div', 'html-rendered', htmlContent, true);  // isHTML should be true
        formats.push({ element: htmlRenderedViewContainer, type: 'html-rendered' });
      }
    }
    // Add HTML/markup format if applicable
    if ((message.startsWith('<') && message.endsWith('>')) || message.startsWith('# ')) {
      const isHTML = message.includes('<html>');
      const htmlFormattedContainer = createContentElement('div', isHTML ? 'html' : 'markup', message, true);
      formats.push({ element: htmlFormattedContainer, type: isHTML ? 'html' : 'markup' });
    }
*/

    return formats;
  }


    function createContentElement(tag, className, content, isHTML = false) {
    console.log('createContentElement():', tag, className);

    // Determine if content is HTML or plain text
    const isHTMLString = typeof content === 'string' && /<\/?[a-z][\s\S]*>/i.test(content);

    const element = document.createElement(tag);
    element.classList.add('content', className);

    if (isHTML) {
      element.innerHTML = content;
    } else {
      element.textContent = content;
    };

    if (className != 'xcode') {
      element.addEventListener('click', function () {
        document.querySelectorAll('.selected').forEach(ta => ta.classList.remove('selected'));
        this.classList.add('selected');
      });
    };
    return element;
  }
</script>


<script>
  function extractAndRenderContentBlocks(message = null) {
    // Retrieve input message or get value from the input element by default
    const messageInput = message || document.getElementById('input').value;

    // Parse the message to identify text and code blocks
    const contentBlocks = findCodeBlocks(messageInput);

    // Create a container for the content blocks
    const contentContainer = document.createElement('div');
    contentContainer.innerHTML = '';

    // Iterate through each content block and create appropriate HTML elements
    contentBlocks.forEach(block => {
      const contentElement = document.createElement('div');
      contentElement.classList.add('content-block');

      if (block.codeType === 'text') {
        // For text blocks, simply set the text content
        contentElement.textContent = block.content;
        //determine text type
        if (block.content.includes('\n')) {
          contentElement.classList.add('textn');
        } else {
          contentElement.classList.add('text');
        }
      } else {
        // For code blocks, create a framed element with copy and toggle buttons

        const frame = document.createElement('div');
        frame.classList.add('code-frame');

        const preElement = document.createElement('pre');
        preElement.textContent = block.content;

        const codeElement = document.createElement('div');
        codeElement.innerHTML = block.content;

        // Create copy button
        const copyButton = document.createElement('button');
        copyButton.textContent = 'copy-block';
        copyButton.classList.add('copy-button');
        copyButton.addEventListener('click', () => {
          navigator.clipboard.writeText(block.content)
            .then(() => alert('Code copied to clipboard!'))
            .catch(err => console.error('Failed to copy text: ', err));
        });

        // Create 'view' toggle button
        const toggleButton = document.createElement('button');
        toggleButton.textContent = 'view-html';
        toggleButton.classList.add('toggle-button');

        let isCodeView = true;
        toggleButton.addEventListener('click', () => {
          if (isCodeView) {
            frame.replaceChild(codeElement, preElement);
          } else {
            frame.replaceChild(preElement, codeElement);
          }
          isCodeView = !isCodeView;
        });

        // Append buttons and pre element to new button container
        const buttonContainer = document.createElement('div');
        buttonContainer.classList.add('button-container');
        buttonContainer.appendChild(copyButton);
        buttonContainer.appendChild(toggleButton);

        // append button container to frame?
        contentElement.appendChild(buttonContainer);
//      frame.appendChild(buttonContainer);
        frame.appendChild(preElement);

        // Append frame to the content element
        contentElement.appendChild(frame);
      }

      // Append the created element to the content container
      contentContainer.appendChild(contentElement);
    });

    // Return the content container with all the blocks appended
    return contentContainer;
  }
</script>


<script>
  function populateMessageTypeSelector(selector, formats) {
    formats.forEach(format => {
        const option = document.createElement('option');
        option.value = format;
        option.textContent = format.toUpperCase();
        selector.appendChild(option);
    });
  }

  function setupMessageTypeSelectorHandler(selector, messageElement) {
    selector.onchange = function () {
        const selectedFormat = this.value;
        const contentContainers = messageElement.querySelectorAll('.content');
        contentContainers.forEach(container => {
            container.classList.toggle('visible', container.classList.contains(selectedFormat));
        });
    };
  }


async function apiCallFunction(functionName, ...args) {
    let defaultResult = '{"status": "success", "message": "The operation completed successfully, no errors were reported."}';
    let response = {};
    if (typeof window[functionName] === 'function') {
        let functionResult = window[functionName](...args);
        let content = functionResult || defaultResult;
        try {
            content = JSON.stringify(JSON.parse(content));
        } catch (error) {
            console.log('--content is not valid JSON:', error);
        }
        response = { role: "function", name: functionName, content };
    } else {
        console.log('Function not found:', functionName);
    }
    return JSON.stringify(response, null, 2);
}

function replaceNullWithEmptyString(obj) {
    for (var key in obj) {
        if (obj[key] === null) {
            obj[key] = "";
        } else if (typeof obj[key] === 'object') {
            obj[key] = replaceNullWithEmptyString(obj[key]);
        }
    }
    return obj;
}

async function getCodeView(elementId) {
    let textContent = {
        body: "",
        response: "",
        status: "",
        usage: ""
    };

    const showBody = document.getElementById('bodyCodeToggleBtn').getAttribute('data-enabled') === 'true';
    const showResponse = document.getElementById('responseCodeToggleBtn').getAttribute('data-enabled') === 'true';
    const showStatus = document.getElementById('statusCodeToggleBtn').getAttribute('data-enabled') === 'true';
    const showUsage = document.getElementById('usageCodeToggleBtn').getAttribute('data-enabled') === 'true';

    const element = document.getElementById(elementId);
    element.value = "";

    let content = await newConversation();
    textContent.body = "----- Body -----\n" + JSON.stringify(content, null, 2) + "\n";
    textContent.response = "----- Response -----\n" + JSON.stringify(lastResponse, null, 2) + "\n";
    textContent.status = "----- Status -----\n" + statusLineList + "\n";
    textContent.usage = "----- Usage -----\n" + JSON.stringify(usageStats, null, 2) + "\n";

    if (showBody) element.value += textContent.body;
    if (showResponse) element.value += textContent.response;
    if (showStatus) element.value += textContent.status;
    if (showUsage) element.value += textContent.usage;
}

function setLeftSidebars() {
    let content =
`{
  "name": "sendEmail",
  "description": "Constructs a mailto link to send an email to the specified recipient with a subject and content.",
  "parameters": {
    "type": "object",
    "properties": {
      "emailTo": {
      "type": "string",
      "description": "The email address of the recipient."
    },
    "subject": {
      "type": "string",
      "description": "The subject line of the email."
    },
    "content": {
      "type": "string",
      "description": "The body content of the email."
    }
    },
    "required": ["emailTo", "subject", "content"]
  }
}`;
    document.getElementById("functionDefInput").value = content;
}

function sendEmail(emailTo, subject, content) {
    var link = "mailto:" + encodeURIComponent(emailTo)
               + "?subject=" + encodeURIComponent(subject)
               + "&body=" + encodeURIComponent(content);
    window.location.href = link;
}
</script>

<!--
<script>
  function openTablePopup(tableId) {
    var popup = document.querySelector('.popup');
    var overlay = document.querySelector('.overlay');
    var popupHeader = document.getElementById('popupHeader');
    var popupTable = document.getElementById('popupTable');

    if (tableId === 'apiHelp') {
      popupHeader.textContent = 'API Parameters Help';
      popupTable.innerHTML = `
        <table>
          <tr>
            <th>Setting</th>
            <th>Description</th>
            <th>Range</th>
            <th>Default Value</th>
            <th>Suggested Value</th>
          </tr>
          <tr>
            <td>API Key</td>
            <td>Unique identifier for accessing OpenAI's API</td>
            <td>N/A</td>
            <td>N/A</td>
            <td>N/A</td>
          </tr>
          <tr>
            <td>Model</td>
            <td>Determines the language model used for text generation</td>
            <td>N/A</td>
            <td>N/A</td>
            <td>N/A</td>
          </tr>
          <tr>
            <td>Temperature</td>
            <td>Controls randomness of generated text</td>
            <td>0.0 to 1.0</td>
            <td>0.7</td>
            <td>0.5</td>
          </tr>
          <tr>
            <td>Top_p</td>
            <td>Controls diversity of generated text by considering most probable tokens</td>
            <td>0.0 to 1.0</td>
            <td>0.9</td>
            <td>0.7</td>
          </tr>
          <tr>
            <td>Frequency Penalty</td>
            <td>Discourages repetitive words in generated text</td>
            <td>0.0 to 1.0</td>
            <td>0.0</td>
            <td>0.3</td>
          </tr>
          <tr>
            <td>Presence Penalty</td>
            <td>Discourages specific tokens in generated text</td>
            <td>0.0 to 1.0</td>
            <td>0.0</td>
            <td>0.1</td>
          </tr>
          <tr>
            <td>Stop Sequence</td>
            <td>Indicates when the generation process should stop</td>
            <td>N/A</td>
            <td>None</td>
            <td>Customized</td>
          </tr>
        </table>
      `;
    } else if (tableId === 'functionDefHelp') {
      popupHeader.textContent = 'functionDef Help';
      popupTable.innerHTML = `
        <table>
          <tr>
            <th>function</th>
            <th>functionDef</th>
          </tr>
          <tr>
            <td>sendEmail()</td>
            <td onclick="setLeftSidebars()">click [here] to load sample</br></br>when this JSON{} is present in the functionDef sidebar it is added to the prompt functions[] and provides a template for the bot to use the function sendEmail()</br></br>This should allow the bot to open your email application and populate it.</td>
          </tr>
        </table>
      `;
    } else if (tableId === 'ollamaHelp') {
      popupHeader.textContent = 'promptGenAI - Ollama Help';
      popupTable.innerHTML = `
        <style>
          p, ul, ol {
            margin-top: .8em;
            margin-left: .8em;
            margin-right: .8em;
          }
          li {
            margin-left: 1.6em;
          }
          code {
            background-color: #f4f4f4;
            padding: 2px 5px;
            border-radius: 3px;
          }
        </style>
        <p><strong>CORs ERRORS and why LOADED MODELS DISAPPEAR (A little insight)</strong></p>
        <ul>
          <li>Default ollama model path is based on username.</li>
          <li>Default install <code>ollama serve</code> is running under userId:ollama.</li>
          <li>When <code>ollama serve</code> is stopped and restarted, it will be running under your userId NOT userId:ollama.</li>
          <li>You will not see the models loaded under a different userId (e.g., ollama) unless you set the OLLAMA_MODELS to point to the userId's models path.</li>
        </ul>
        <p><strong>The 2-steps below will bypass the CORS and point to the 'missing' ollama models:</strong></p>
        <ol>
          <li>Stop the ollama service:<br><code>systemctl stop ollama</code></li>
          <li>Restart ollama serve with parameters to bypass CORS, use default http:port and 'ollama' model path:<br><code>OLLAMA_ORIGINS=* OLLAMA_HOST=127.0.0.1:11434 OLLAMA_MODELS=/usr/share/ollama/.ollama/models ollama serve</code></li>
        </ol>
        <p><strong>Ollama default install values:</strong></p>
        <ul>
          <li>Host:Port - <code>OLLAMA_HOST=127.0.0.1:11434</code></li>
          <li>Model location - <code>OLLAMA_MODELS=/usr/share/ollama/.ollama/models</code></li>
          <li>Origins - <code>OLLAMA_ORIGINS= (empty)</code></li>
        </ul>
        <p><strong>To bypass the following errors (these are browser side errors not ollama errors):</strong></p>
        <ul>
          <li>Cross-Origin Request Blocked (CORS error)</li>
          <li>Access-Control-Allow-Origin</li>
        </ul>
        <p>This typically occurs when not using a server where ollama and the browser are on localhost but different users.</p>
        <ul>
          <li>Use - <code>OLLAMA_ORIGINS=*</code></li>
        </ul>
        <p><strong>Curl Statements:</strong></p>
        <ul>
          <li>Install or Update Ollama:</li>
          <code>curl -fsSL https://ollama.com/install.sh | sh</code>
          <br><br>
          <li>Get list of model tags available to active address:port (JSON):</li>
          <code>curl http://127.0.0.1:11434/api/tags</code>
          <br><br>
          <li>Pull an ollama model (or update a model)</li>
          <code>curl http://127.0.0.1:11434/api/pull -d '{"name": "tinydolphin:1.1b-v2.8-q5_K_M"}'</code>
          <br><br>
        </ul>
        <p><em>Disclaimer: The information provided here is for general informational purposes only. All information on the site is provided in good faith, however, we make no representation or warranty of any kind, express or implied, regarding the accuracy, adequacy, validity, reliability, availability, or completeness of any information on the site.</em></p>
      `;
    }

    popup.style.display = 'block';
    overlay.style.display = 'block';
  }

/*
  document.querySelector('.overlay').addEventListener('click', function() {
    document.querySelector('.popup').style.display = 'none';
    document.querySelector('.overlay').style.display = 'none';
  });
*/

</script>
-->

<script>
// +c20240521T1300
function findCodeBlocks(input) {
  console.log('findCodeBlocks():');
  if (typeof input !== 'string') {
    throw new TypeError('Input must be a string');
  }
  const codeBlockRegex = /```(.*?)\n([\s\S]*?)```/g;
  const parsedBlocks = [];
  let lastIndex = 0;
  let match;
  while ((match = codeBlockRegex.exec(input)) !== null) {
    // Extract and add the text before the current code block
    const precedingText = input.slice(lastIndex, match.index).trim();
    if (precedingText) {
      parsedBlocks.push({ codeType: 'text', content: precedingText });
    }
    // Extract code type and content from match
    const codeType = match[1].trim();
    const codeContent = match[2].trim();
    parsedBlocks.push({ codeType, content: codeContent });

    // Update lastIndex to the end of the current match
    lastIndex = codeBlockRegex.lastIndex;
  }
  // Add any remaining text after the last code block
  const remainingText = input.slice(lastIndex).trim();
  if (remainingText) {
    parsedBlocks.push({ codeType: 'text', content: remainingText });
  }
  return parsedBlocks;
}
</script>

<script>
  // TEXT TO SPEECH
  document.getElementById('volume').value = localStorage.getItem('volume') || 1;
  document.getElementById('rate').value = localStorage.getItem('rate') || 1;
  document.getElementById('pitch').value = localStorage.getItem('pitch') || 1;

  function toggleSpeech() {
    var selectedElement = document.querySelector('.selected');
    if (selectedElement) {
      var text;
      if (selectedElement.tagName === 'TEXTAREA' || selectedElement.tagName === 'INPUT') {
        text = selectedElement.value;
      } else {
        text = selectedElement.textContent;
      }
      var speech = new SpeechSynthesisUtterance(text);
      speech.volume = document.getElementById('volume').value;
      speech.rate = document.getElementById('rate').value;
      speech.pitch = document.getElementById('pitch').value;
      if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
      } else {
        window.speechSynthesis.speak(speech);
      }
    } else {
      alert("Please select a text to convert to speech");
    }
  }

  function stopSpeech() {
    window.speechSynthesis.cancel();
  }

  function toggleTtsSettings() {
    var settingsContent = document.getElementById("settingsContent");
    settingsContent.style.display = settingsContent.style.display === "block" ? "none" : "block";
  }
</script>

<script>
  function initializeRangeInputs() {
    const rangeInputs = document.querySelectorAll('input[type="range"]');

    function updateRelatedElement(source, target) {
      const value = source.value;
      target.value = value;
    }

    rangeInputs.forEach(rangeInput => {
      rangeInput.addEventListener('input', function() {
        const relatedInputId = this.id.replace('-slider', '');
        const relatedInput = document.getElementById(relatedInputId);
        updateRelatedElement(this, relatedInput);
      });

      const relatedNumberInputId = rangeInput.nextElementSibling.id;
      const relatedNumberInput = document.getElementById(relatedNumberInputId);
      relatedNumberInput.addEventListener('input', function() {
        if (this.value < +rangeInput.min) this.value = rangeInput.min;
        if (this.value > +rangeInput.max) this.value = rangeInput.max;
        updateRelatedElement(this, rangeInput);
      });
    });

    rangeInputs.forEach(rangeInput => {
      rangeInput.dispatchEvent(new Event('input'));
    });
  }
</script>

<script>
  function createStatusLine(response) {
    const createdDate = new Date(response.created * 1000);
    const elapsedSeconds = (endTime - startTime) / 1000;
    const statusAPI = (selectedAPI.parameters.key.slice(-4) ?? "");
    const statusDTS = createdDate.toISOString().replace(/[:T-]/g, "").slice(0, 14);
    let statusParts = [];

    function traverseAndCollect(obj, path) {
      for (let key in obj) {
        if (obj.hasOwnProperty(key) && key !== 'choices') {
          let newPath = path ? `${path}.${key}` : key;
          if (typeof obj[key] === 'object' && obj[key] !== null) {
            traverseAndCollect(obj[key], newPath);
          } else {
            statusParts.push(`${newPath}: ${obj[key]}`);
          }
        }
      }
    }

    traverseAndCollect(response, '');

    let statusLine = statusParts.join(', ').replace(/\s+/g, '').replace(/,/g, ' |').replace(/usage\./g, '');
    statusLine += `|API:${statusAPI} |DTS:${statusDTS}_${elapsedSeconds}`;
    statusLineList += '\n' + statusLine;
    return statusLine;
  }
</script>

<script>
  const usageStats = {
    last: { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 },
    chat: { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 },
    conversation: { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 },
    session: { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 },

    updateUsage: function(response) {
      this.last = response.usage;
      this.chat.prompt_tokens += response.usage.prompt_tokens;
      this.chat.completion_tokens += response.usage.completion_tokens;
      this.chat.total_tokens += response.usage.total_tokens;
      this.conversation.prompt_tokens += response.usage.prompt_tokens;
      this.conversation.completion_tokens += response.usage.completion_tokens;
      this.conversation.total_tokens += response.usage.total_tokens;
      this.session.prompt_tokens += response.usage.prompt_tokens;
      this.session.completion_tokens += response.usage.completion_tokens;
      this.session.total_tokens += response.usage.total_tokens;
    },

    resetLast: function() {
      this.last = { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
    },

    resetChat: function() {
      this.resetLast();
      this.chat = { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
    },

    resetConversation: function() {
      this.resetChat();
      this.conversation = { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
    },

    resetSession: function() {
      this.resetConversation();
      this.session = { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
    },
  };
</script>

<script>
  function jsonToHtmlTable(jsonData, axis) {
    const keys = Object.keys(jsonData);
    const subKeys = Object.keys(jsonData[keys[0]]);

    let table = document.createElement('div');
    table.className = 'json-table';

    let header = document.createElement('div');
    header.className = 'json-table-header';
    if (axis === 'rows') {
      header.appendChild(document.createElement('div'));
      subKeys.forEach(subKey => {
        let cell = document.createElement('div');
        cell.textContent = subKey;
        header.appendChild(cell);
      });
    } else {
      keys.forEach(key => {
        let cell = document.createElement('div');
        cell.textContent = key;
        header.appendChild(cell);
      });
    }
    table.appendChild(header);

    if (axis === 'rows') {
      keys.forEach(key => {
        let row = document.createElement('div');
        row.className = 'json-table-row';
        let headerCell = document.createElement('div');
        headerCell.textContent = key;
        row.appendChild(headerCell);
        subKeys.forEach(subKey => {
          let cell = document.createElement('div');
          cell.textContent = jsonData[key][subKey];
          row.appendChild(cell);
        });
        table.appendChild(row);
      });
    } else {
      subKeys.forEach(subKey => {
        let row = document.createElement('div');
        row.className = 'json-table-row';
        keys.forEach(key => {
          let cell = document.createElement('div');
          cell.textContent = jsonData[key][subKey];
          row.appendChild(cell);
        });
        table.appendChild(row);
      });
    }

    return table;
  }
</script>

<script>
  function localStoreValueByTag(storeValue, tag = '') {
    let timestamp = new Date().getTime();
    let storageKey = `${tag}_${timestamp}`;
    localStorage.setItem(storageKey, storeValue);
    alert(`Data stored successfully!\nstorageKey: ${storageKey}`);
  }

  function localStoreElementContents(elementIds, tag = '') {
    let output = {};
    if (elementIds.length === 0) {
      const indicators = document.querySelectorAll('#indicatorBar .indicator');
      indicators.forEach(indicator => {
        elementIds.push(indicator.id.replace('indicator-', ''))
      })
      elementIds.push("statusBarText");
    }

    elementIds.forEach(id => {
      let element = document.getElementById(id);
      if (element) {
        if (element.tagName === 'INPUT' || element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
          output[id] = element.value;
        } else {
          output[id] = element.innerHTML;
        }
      }
    });
    let jsonString = JSON.stringify(output);
    let timestamp = new Date().getTime();
    let storageKey = `${tag}_${timestamp}`;
    localStorage.setItem(storageKey, jsonString);
    alert('Data stored successfully!');
  }

  function retrieveLocalStoredData(tag = '') {
    let storedData = {};
  //for (let i = 0; i < localStorage.length; i++) {    // -t20240516T1328 - replaced with Object.keys
    Object.keys(localStorage).forEach((key) => {
      let storageKey = localStorage.key(i);
      if (storageKey.startsWith(tag)) {
        let storedItem = localStorage.getItem(storageKey);
        try {
          let data = JSON.parse(storedItem);
          storedData[storageKey] = data;
        } catch (e) {
          storedData[storageKey] = storedItem;
        }
      }
    })
    const jsonString = JSON.stringify(storedData, null, 2);

    navigator.clipboard.writeText(jsonString)
      .then(() => alert('Retrieved Data and copied to clipboard: ' + jsonString))
      .catch(err => console.error('Could not copy to clipboard: ', err));
  }

  function downloadLocalStorageData(tag = '') {
    var text = '';
    for (var i = 0; i < localStorage.length; i++) {
      var key = localStorage.key(i);
      var value = localStorage.getItem(key);
      if (key.startsWith(tag) && key != 'apiKey') {
        text += key + ': ' + value + '\n';
      }
    }
    var textFile = new Blob([text], { type: 'text/plain' });
    var downloadLink = document.createElement('a');
    downloadLink.download = 'localStorageData.txt';
    downloadLink.href = window.URL.createObjectURL(textFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
  }
</script>

<script>
  function addModelsToModelSelector(api) {
    const selector = document.getElementById('apiModel');

    const optionDivider = document.createElement('option');
    optionDivider.value = '';
    optionDivider.text = '-- ' + api.label + ' models --';
    selector.appendChild(optionDivider);

    api.models.forEach(model => {
      const option = document.createElement('option');
      option.id = model.model;
      option.value = model.model;
      option.text = model.name || model.model;
      option.classList.add(api.label);
      selector.appendChild(option);
    });

    populateElementId('apiModel', api.parameters.model);
  }
</script>

<script>
  function createParameterInputPair(parameter, value) {
    value = /.*YOUR.*API_KEY.*/.test(value) ? '' : value;  // Clear default API placeholders
    let inputPair = document.createElement('div');
    inputPair.className = 'input-pair';

    let label = document.createElement('label');
    label.htmlFor = 'apix' + parameter.charAt(0).toUpperCase() + parameter.slice(1);
    label.textContent = parameter + ':';
    inputPair.appendChild(label);

    let input = document.createElement('input');
    input.className = 'parameter';
    input.type = 'text';
    input.id = 'apix' + parameter.charAt(0).toUpperCase() + parameter.slice(1);
    input.value = value;
    input.title = parameter.charAt(0).toUpperCase() + parameter.slice(1) + ' Input';
    if (input.id === 'apixKey') {
      input.placeholder = 'Enter API Key';
      input.type = 'password';
      input.onblur = () => handleBlur();
    };

    inputPair.appendChild(input);

    document.getElementById('apiParametersContainer').appendChild(inputPair);
  }
</script>

<script>
  function populateElementId(elementId, value) {
    let element = document.getElementById(elementId);
    if (element) {
      if (element.tagName.toLowerCase() === 'input' || element.tagName.toLowerCase() === 'textarea') {
        element.value = value;
      } else if (element.tagName.toLowerCase() === 'select') {
        for (let option of element.options) {
          if (option.value === value) {
            option.selected = true;
            break;
          }
        }
      } else {
        element.value = value;
      }
    }
  }
</script>

<script>
  function selectElementIdFromClass(elementId, fromClass) {
    console.log('selectElementIdFromClass:', elementId, fromClass);
    var elements = document.getElementsByClassName(fromClass);
    for (var i = 0; i < elements.length; i++) {
      elements[i].classList.remove('selected');
    }
    document.getElementById(elementId).classList.add('selected');
  }
</script>

<script>
  apiModel.addEventListener('change', () => {
    console.log('apiModel Listener:','change');
    let selectedModelClass = '';
    for (let option of apiModel.options) {
      if (option.value === apiModel.value) {
        option.selected = true;
        selectedModelClass = option.className;
        break;
      }
    }

    const containerId = document.getElementById('apiParametersContainer');
    let parameterIds = containerId.getElementsByClassName('parameter');
    for (let parameterId of parameterIds) {
      let param = parameterId.labels[0].childNodes[0].data.slice(0, -1);
      let value = parameterId.value;
      selectedAPI.parameters[param] = value;
    };

    containerId.innerHTML = '';

    try {
      selectedAPI = apis.find(api => api.label === selectedModelClass);
    } catch {}

    if (selectedAPI) {
      console.log('set selectedAPI:', selectedAPI);
      document.getElementById('apiParametersToggleBtn').textContent = `${selectedAPI.label} Parameters`;
      selectedAPI.parameters.model = apiModel.value;
      selectElementIdFromClass('card-' + selectedAPI.label, 'api-card');

      endpointKey = (typeof yekKit !== 'undefined' && yekKit) ? yekKit : (selectedAPI && selectedAPI.parameters && selectedAPI.parameters.key ? selectedAPI.parameters.key : '');
      chatReadyCheck('sendButtonIndicator', endpointKey);

    } else {
      selectedAPI = '';
      console.log('err selectedAPI:', 'not found');
      document.getElementById('apiParametersToggleBtn').textContent = `No API found for Model`;
    }

    containerId.innerHTML = '';
    for (let param in selectedAPI.parameters) {
      createParameterInputPair(param, selectedAPI.parameters[param]);
    };
  });
</script>

<script>
  function clickOptionByElementId(elementId, option) {
    var selectElement = document.getElementById(elementId);
    for (var i = 0; i < selectElement.options.length; i++) {
      if (selectElement.options[i].value == option) {
        selectElement.options[i].click();
        break;
      }
    }
  }

  function selectOptionByElementId(elementId, option) {
    var selectElement = document.getElementById(elementId);
    for (var i = 0; i < selectElement.options.length; i++) {
      if (selectElement.options[i].value == option) {
        selectElement.selectedIndex = i;
        break;
      }
    }
    var event = new Event('change');
    selectElement.dispatchEvent(event);
  }

  function getApiByLabel(apiLabel) {
    let api = apis.find(api => apiLabel === apiLabel);
    let model = api.parameters.model;
    selectOptionByElementId('apiModel', model);
    return api;
  }

  function selectApiByLabel(apiLabel) {
    let api = apis.find(api => api.label === apiLabel);
    let model = api.parameters.model;
    selectOptionByElementId('apiModel', model);
  }
</script>

<script>
  function buildImportTemplate(key, value) {
    let importFileName = 'importData-' + key + '.js';
    let importFunctionName = 'importData_' + key;

    let template = `
    if (typeof imported_apis !== 'undefined') {
      console.log('imported_${key}:', 'ALREADY EXISTS');
    } else {
      let imported_${key};
    };

    function ${importFunctionName}(${key}) {
      let exported_${key} = ${value};
      try {
        imported_${key} = JSON.parse(exported_${key});
      } catch {
        imported_${key} = exported_${key};
      }
    }

    ${importFunctionName}();
    `;

    return template;
  }

  function exportExternalValues(tag = '') {
    var text = '';
    for (var i = 0; i < localStorage.length; i++) {
      var key = localStorage.key(i);
      var value = localStorage.getItem(key);
      text += buildImportTemplate(key, value);
      text += '\n';
    }
    var textFile = new Blob([text], { type: 'text/plain' });
    var downloadLink = document.createElement('a');
    downloadLink.download = 'importData-' + tag + '.js';
    downloadLink.href = window.URL.createObjectURL(textFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
  }

  function importExternalValues(tag) {
    importFileName = 'importData-' + tag + '.js';

    if (tag) {
      var script = document.createElement('script');
      script.src = importFileName;
      script.onload = function () {};
      document.head.appendChild(script);
    }
  }
</script>


<script>
  function getUrlParameters() {
    var urlParams = {};
    var queryString = window.location.search.substring(1);
    var params = queryString.split('&');

    for (var i = 0; i < params.length; i++) {
      var pair = params[i].split('=');
      var key = decodeURIComponent(pair[0]);
      var value = decodeURIComponent(pair[1]);
      if (key) {
        urlParams[key] = value;
      }
    }
    console.log('urlParams:', urlParams);
    return urlParams;
  }

  function toggleUrlparams() {
    let urlParams = getUrlParameters();
      Object.keys(urlParams).forEach(key => {
        let toggleBtnId = key + 'ToggleBtn';
        let toggleBtn = document.getElementById(toggleBtnId);
        if (toggleBtn) {
          toggleBtn.click();
          console.log(`Clicked button with id ${toggleBtnId} for key ${key} and value ${urlParams[key]}`);
        } else {
          //console.log(`Button with id ${toggleBtnId} not found for key ${key} and value ${urlParams[key]}`);
        }
      });
  }
  toggleUrlparams();
</script>


<script>
function waitForValue(checkVariable, interval, timeout) {
  return new Promise((resolve, reject) => {
    let startTime = Date.now();

    const intervalId = setInterval(() => {
      if (checkVariable) {
        clearInterval(intervalId);
        resolve(checkVariable);
      } else if (Date.now() - startTime > timeout) {
        clearInterval(intervalId);
        reject(new Error('Timeout waiting for value'));
      }
    }, interval);
  });
}
/*
//Example usage:
let myVariable;

waitForValue(myVariable, 1000, 5000)
  .then(value => {
    console.log('Value is:', value);
  })
  .catch(error => {
    console.error(error);
  });
*/
</script>

<script> // not currently used zzz 20240529T1904
function markdownToHtml(markdown) {
  let html = markdown
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    .replace(/^\- (.*$)/gim, '<ul><li>$1</li></ul>')
    .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
    .replace(/\*(.*)\*/gim, '<i>$1</i>')
    .replace(/\[(.*?)\]\((.*?)\)/gim, '<a href="$2">$1</a>')
    .replace(/\n$/gim, '<br />');
    // Handle nested lists
    html = html.replace(/<\/ul>\n<ul>/g, '');
  return html.trim();
}
</script>

<script>
  function clickElementById(id) {
    var element = document.getElementById(id);
    if (element) {
      element.click();
    }
  }

//clickElementById('bodyCodeToggleBtn');
//clickElementById('enterToSendBtn');
//clickElementById('statusBarToggleBtn');
//clickElementById('extControlsToggleBtn');

</script>

<script>
  function syntaxHighlight(json) {
    if (typeof json != 'string') {
      json = JSON.stringify(json, undefined, 2);
    }
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
      let cls = 'number';
      if (/^"/.test(match)) {
        if (/:$/.test(match)) {
          cls = 'key';
        } else {
          cls = 'string';
        }
      } else if (/true|false/.test(match)) {
        cls = 'boolean';
      } else if (/null/.test(match)) {
        cls = 'null';
      }
      return '<span class="' + cls + '">' + match + '</span>';
    });
  }

  function jsonDisplayById(jsonData, elementId) {
    console.log('jsonDisplayById():',jsonData, elementId);
    document.getElementById(elementId).innerHTML = syntaxHighlight(jsonData);
  }
</script>

<script>  // zzz 20240529T1911 -- do not modify this code - future use
function fetchModelDetails(api, model) {
  if (!api || !api.endpoint || !api.endpoint.modelShow || !model) {
    return Promise.reject(new Error("API endpoint or model is not provided."));
  }

  const url = api.endpoint.modelShow;
  const payload = { name: model };

  return fetch(url, {
    method: 'POST',
    headers: api.endpoint.headers,
    body: JSON.stringify(payload)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! ${api.label} status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => data)
  .catch(error => {
    console.error("Failed to fetch model details:", api.label, error);
    throw error;
  });
}
</script>

<script>
  function handleBlur() {
    //console.log('Element apixKey has lost focus');
    apiModel.dispatchEvent(new Event('change'));
  }
</script>

<!--
url parameters
  extControls - toggles id=extControlsToggleBtn - container for export/import apis buttons
-->

  <script> // UTILITY FUNCTION - VOICE-TO-TEXT

    let recognition;
    const continuous = document.querySelector("#continuous");
    const interim = document.querySelector("#interim");
    const maxAlt = document.querySelector("#maxAlt");
    const lang = document.querySelector("#lang");
    const transcripts = document.querySelector("#transcripts");
    const startBtn = document.querySelector("#start");
    const stopBtn = document.querySelector("#stop");
    const resetBtn = document.querySelector("#reset");

    const vttLog = document.getElementById("voiceToTextLog");
    vttLog.value = "";

    resetRecognition();

    function resetRecognition() {
      console.log('resetRecognition():');
      if ('SpeechRecognition' in window) {
        recognition = new SpeechRecognition();
        console.log("SpeechRecognition - found");
        vttLog.value += "SpeechRecognition - found\n";
      } else if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        console.log("webkitSpeechRecognition - found");
        vttLog.value += "webkitSpeechRecognition - found\n";
      } else {
        console.log("Speech recognition not supported on your browser");
        vttLog.value += "Speech recognition not supported on your browser\n";
        return;
      }
      recognition.continuous = continuous.checked;
      recognition.interimResults = interim.checked;
      recognition.maxAlternatives = maxAlt.value;
      recognition.lang = lang.value;
      //logging to console and voice to text log window
      vttLog.value += '.continuous: ' + recognition.continuous + '\n';
      vttLog.value += '.interimResults: ' + recognition.interimResults + '\n';
      vttLog.value += '.maxAlternatives: ' + recognition.maxAlternatives + '\n';
      vttLog.value += '.lang: ' + recognition.lang + '\n';
      vttLog.scrollTop = vttLog.scrollHeight;
      //
      recognition.onresult = (event) => {
        console.log('.onresult:', event);
        let finalTranscript = "";
        let interimTranscript = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }
        //messages.value = 'Final Transcript:'+finalTranscript+'  Interim Transcript:'+interimTranscript
        transcripts.value = finalTranscript;
      };
    } // end - resetRecognition

    startBtn.addEventListener("click", () => {
      console.log('eventListener:', "#start");
      vttLog.value += 'eventListener: #start\n';
      vttLog.scrollTop = vttLog.scrollHeight;
      recognition.start();
    });

    stopBtn.addEventListener("click", () => {
      console.log('eventListener:', "#stop");
      vttLog.value += 'eventListener: #stop\n';
      vttLog.scrollTop = vttLog.scrollHeight;
      recognition.stop();
    });

    resetBtn.addEventListener("click", () => {
      console.log('eventListener:', "#reset");
      vttLog.value += 'eventListener: #reset\n';
      vttLog.scrollTop = vttLog.scrollHeight;
      recognition.abort();
      resetRecognition();
    });

    // voiceToText transcripts (output)
    function transcriptAdd(elementId) {
        const voiceToText = ' ' + document.getElementById("transcripts").value;
        document.getElementById(elementId).value += voiceToText;
    }

    // voiceToText transcripts (output)
    function transcriptReplace(elementId) {
        const voiceToText = document.getElementById("transcripts").value
        document.getElementById(elementId).value = voiceToText;
    }


    // voiceToText transcripts (output) replaced 20231025T0627
    function xaddToPrompt() {
        const voiceToText = ' ' + document.getElementById("transcripts").value;
        document.getElementById("prompt").value += voiceToText;
    }

    // voiceToText transcripts (output) replaced 20231025T0627
    function xreplacePrompt() {
        const voiceToText = document.getElementById("transcripts").value
        document.getElementById("prompt").value = voiceToText;
    }
  </script> <!-- end - UTILITY FUNCTION - VOICE-TO-TEXT -->

<script>
  function toggleSettingsVisibility(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
      element.classList.toggle('hidden');
    }
  }

  function toggleSettingsButtonState(button) {
    const isEnabled = button.getAttribute('data-enabled') === 'true';
    button.setAttribute('data-enabled', !isEnabled);
    button.textContent = button.textContent.replace(isEnabled ? 'ON' : 'OFF', isEnabled ? 'OFF' : 'ON');
  }

  function buildSettingsNavList() {
  	console.log('buildSettingsNavList()');
    const sections = document.querySelectorAll('.settings-page .settings-pane-right .section');
    const navList = document.getElementById('navList');
    sections.forEach(section => {
      const label = section.querySelector('h3').textContent;
      const icon = section.querySelector('.icon').textContent.trim();
      const li = document.createElement('li');
      const a = document.createElement('a');
      console.log('...section:', section.id, label, icon, li, a);
      a.href = `#${section.id}`;
      a.innerHTML = `<span class="navicon">${icon}</span><span class="label">${label}</span>`;
      a.title = label;
      li.appendChild(a);
      navList.appendChild(li);
    });
  }

  document.addEventListener('DOMContentLoaded', buildSettingsNavList);
</script>

<script>
  function applyResponsiveStyles() {
    const container = document.getElementById('settingsPageContainer');
    const width = container.offsetWidth;
    console.log('applyResponsiveStyles():', width, container);
    // Remove previously applied custom classes
    container.classList.remove('small', 'medium', 'large');

    // Apply custom class based on container width
    if (width >= 430 && width < 750) {
      container.classList.add('small');
    } else if (width >= 750 && width < 800) {
      container.classList.add('medium');
    } else if (width >= 800) {
      container.classList.add('large');
    }
  }
  // Initial check
  applyResponsiveStyles();
  // Optional: Add event listener for container resize if the container can be resized independently
  const observer = new ResizeObserver(applyResponsiveStyles);
  observer.observe(document.getElementById('settingsPageContainer'));
</script>




<script>
  function toggleState(indicatorId, startIds, stopIds, forceState, delay = 0) {
    const indicator = document.getElementById(indicatorId);
    startIds = Array.isArray(startIds) ? startIds : [startIds];
    stopIds = Array.isArray(stopIds) ? stopIds : [stopIds];

    if (!indicator.originalTextContent) {
      indicator.originalTextContent = indicator.textContent;
    }

    let isStarted = indicator.classList.contains('started');
    let isStopped = indicator.classList.contains('stopped');

    if (!isStarted && !isStopped && !forceState) {
      forceState = 'start';
    }

    const processClicks = (ids) => {
      if (ids.length === 0) return;

      const clickElement = (id, index) => {
        const element = document.getElementById(id);
        if (element) {
          element.click();
        }
        if (index < ids.length - 1) {
          setTimeout(() => clickElement(ids[index + 1], index + 1), delay);
        }
      };

      clickElement(ids[0], 0);
    };

    if (forceState === 'start' || (isStopped && forceState !== 'stop')) {
      processClicks(startIds);
      indicator.classList.remove('stopped');
      indicator.classList.add('started');
      indicator.innerHTML = indicator.originalTextContent + ' started';
    } else {
      processClicks(stopIds);
      indicator.classList.remove('started');
      indicator.classList.add('stopped');
      indicator.innerHTML = indicator.originalTextContent + ' stopped';
    }
  }
  // example useage: toggleState('indicatorId', ['startBtn1', 'startBtn2'], ['stopBtn1', 'stopBtn2'], 'start', 500);
</script>    
<!--
<script>
  function toggleState(indicatorId, startId, stopId, forceState) {
    const indicator = document.getElementById(indicatorId);
    const startBtn = document.getElementById(startId);
    const stopBtn = document.getElementById(stopId);

    if (!indicator.originalTextContent) {
      indicator.originalTextContent = indicator.textContent;
    }

    let isStarted = indicator.classList.contains('started');
    let isStopped = indicator.classList.contains('stopped');

    if (!isStarted && !isStopped && !forceState) {
      forceState = 'start';
    }

    if (forceState === 'start' || ( isStopped && forceState !== 'stop')) {
      startBtn.click();
      indicator.classList.remove('stopped');
      indicator.classList.add('started');
      indicator.innerHTML = indicator.originalTextContent + ' started';
    } else {
      stopBtn.click();
      indicator.classList.remove('started');
      indicator.classList.add('stopped');
      indicator.innerHTML = indicator.originalTextContent + ' stopped';
    }
  }
</script>
-->

<!--
<script>  // template - needs work - 20240610
    function isHTML(text) {
      return /<html[\s>]|<!DOCTYPE html>/i.test(text);
    }
    function isExecutableHTML(text) {
      return isHTML(text) && /<script[\s>]/i.test(text);
    }
    function isJSON(text) {
      if (/^[\s]*[\{\[]/.test(text)) {
        try {
          JSON.parse(text);
          return true;
        } catch (e) {
          return false;
        }
      }
      return false;
    }
    function isXML(text) {
      if (/^[\s]*<\?xml[\s>]/i.test(text) || /^[\s]*<[^>]+>/i.test(text)) {
        try {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(text, 'application/xml');
          const parserError = xmlDoc.getElementsByTagName('parsererror');
          return parserError.length === 0;
        } catch (e) {
          return false;
        }
      }
      return false;
    }
    function isPython(text) {
      return /^\s*(def |import )/m.test(text);
    }
    function isMarkdown(text) {
      return /^[\s]*[#]+[\s]+|```/m.test(text);
    }
    function isJavaScript(text) {
      return /^\s*(function |const |let |var )/m.test(text);
    }
    function isCSS(text) {
      return /^\s*[.#\w][^{}]*\{\s*[^}]*\}/m.test(text);
    }
    function isSQL(text) {
      return /^\s*(SELECT|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER)\b/i.test(text);
    }
    function isCSV(text) {
      return /^[^,\n]+(,[^,\n]+)+(\n[^,\n]+(,[^,\n]+)+)*$/m.test(text);
    }
    function isFormattedText(text) {
      return /\s/.test(text);
    }
</script>
-->

</body>
</html>